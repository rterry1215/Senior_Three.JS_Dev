(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.Rhubarb=b()})(this,function(){'use strict';function a(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})}var b=function(){this.cache={}};b.prototype.destroy=function(){this.cache={}},b.prototype.notify=function(a){if(!this.cache[a]){var b=new Float32Array(a),c=new Uint8Array(b.buffer);this.cache[a]={uint8:c,float32:b}}},b.prototype.get=function(a){var b=this.cache[a];if(!b)throw new Error("ReusableBufferCache is empty.");return b};for(var c=new b,d=["!","\"","#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","R","S","T","U","V","W","X","Y","Z","[","\\","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","r","s","t","u","v","w","x","y","z","{","|","}","~","q","Q"," "],e={},f={},g=0;g<d.length;g++)e[d[g]]=g+1,f[g+1]=d[g];var h=function(a,b){this.name=a,this.id=b,this.parameters={},this.parameterIDsByParameterName={},this.parameterBufferIndicesByParameterName={},this.parameterValues={},this.boundGetter=this.getter.bind(this)};h.prototype.MAX_STRING_PARAMETER_LENGTH=100,h.prototype.typeNumerical={isNumerical:!0,requiredBufferLen:2},h.prototype.getter=function(a){return this.parameterValues[a]},h.prototype.onValuesReceived=function(a){this.onReceived&&this.hasOwnership&&this.onReceived(this.boundGetter,a)},h.prototype.onOwnershipReceived=function(a){this.transferableMessageBody=a,this.transferableList[0]=a.buffer,this.hasOwnership=!0},h.prototype.getCharByte=function(a){return e[a]||0},h.prototype.getParameterFromBuffer=function(a){var b=this.parameters[a];if(!b)throw new Error("No such parameter: "+a+" in protocol: "+this.name);var d=this.parameterBufferIndicesByParameterName[a];if(b.isNumerical){var e=this.buffer[d+1];return this.parameterValues[a]=e,e}for(var g=c.get(b.requiredBufferLen),h=g.float32,j=0;j<b.requiredBufferLen;j++)h[j]=this.buffer[d+1+j];for(var k=g.uint8,e="",j=0;j<k.length&&0!=k[j];j++)e+=f[k[j]];return this.parameterValues[a]=e,e},h.prototype.setParameterToBuffer=function(a,b){var d=this.parameters[a];if(!d)throw new Error("No such parameter: "+a+" in protocol: "+this.name);var e=this.parameterBufferIndicesByParameterName[a],f=this.parameterIDsByParameterName[a];if(this.buffer[e]=f,d.isNumerical)this.buffer[e+1]=b;else{if(b.length>d.maxLength)throw new Error("Parameter overflow: "+a+" in protocol "+this.name);for(var g=c.get(d.requiredBufferLen),h=g.uint8,j=0;j<h.length;j++)h[j]=j<b.length?this.getCharByte(b[j]):0;for(var k=g.float32,l=e+1,j=0;j<k.length;j++)this.buffer[l++]=k[j]}this.parameterValues[a]=b},h.prototype.addNumericalParameter=function(a){this.parameters[a]=this.typeNumerical},h.prototype.addStringParameter=function(a,b){if(b>this.MAX_STRING_PARAMETER_LENGTH)throw new Error("Parameter size exceeds max allowed string parameter size "+this.MAX_STRING_PARAMETER_LENGTH);this.parameters[a]={isNumerical:!1,maxLength:b,requiredBufferLen:Math.ceil(b/4)+1}},h.prototype.init=function(){var a=0,b=0;for(var d in this.parameters){this.parameterIDsByParameterName[d]=b++,this.parameterBufferIndicesByParameterName[d]=a+1;var e=this.parameters[d];a+=e.requiredBufferLen,e.isNumerical||c.notify(e.requiredBufferLen)}this.buffer=new Float32Array(a+1),this.buffer[0]=this.id,this.transferableMessageBody=new Float32Array(a+1),this.transferableList=[this.transferableMessageBody.buffer],this.hasOwnership=!0};var j=function(){this.NUMERICAL_TYPE="numerical",this.CHARACTER_TYPE="char",this.currentProtocolID=1};j.prototype.destroy=function(){this.currentProtocolID=1},j.prototype.parseCharacterType=function(a){var b=a.split("_");return!(b[0]!=this.CHARACTER_TYPE)&&!!b[1]&&parseInt(b[1])},j.prototype.parseProtocol=function(a,b,c){var d=new h(b,c);for(var e in a){var f=a[e];if(f==this.NUMERICAL_TYPE)d.addNumericalParameter(e);else if(f.startsWith(this.CHARACTER_TYPE)){var g=this.parseCharacterType(f);if(!g)throw new Error("Char types must be in format char_N, where N is the char length.");d.addStringParameter(e,g)}else throw new Error("Invalid parameter type.")}return d.init(),d},j.prototype.parse=function(a){var b={};for(var c in a){var d=a[c],e=this.parseProtocol(d,c,this.currentProtocolID++);b[e.name]=e}return b};var k=new j,l=function(){this.isReady=!1};l.prototype.destroy=function(){this.protocolsByProtocolName={},this.protocolsByProtocolID={},this.isReady=!1,this.server=null},l.prototype.setReady=function(){this.isReady=!0,this.onReady&&this.onReady()},l.prototype.set=function(a){for(var b in this.protocolsByProtocolName={},this.protocolsByProtocolID={},a){var c=a[b];this.protocolsByProtocolName[b]=c,this.protocolsByProtocolID[c.id]=c}},l.prototype.setServer=function(a){this.server=a};var m=new l,n=function(){this.isWorkerInitialized=!1,this.reusableArray=[]};n.prototype.destroy=function(){delete this.onDisconnectedFromServer,delete this.latencyCallback,this.isWorkerInitialized=!1,this.reusableArray=[],this.worker.terminate()},n.prototype.onLatencyUpdated=function(a){this.latencyCallback&&this.latencyCallback(a)},n.prototype.sendProtocol=function(a){if(!a.hasOwnership)return void console.error("Protocol does not have transferable ownership.");for(var b=0;b<a.buffer.length;b++)a.transferableMessageBody[b]=a.buffer[b];this.worker.postMessage(a.transferableMessageBody,a.transferableList),a.hasOwnership=!1},n.prototype.initialize=function(a,b){this.worker=new Worker(a),this.worker.onmessage=function(a){var b=a.data;if(b.isError)return void this.onError("Cannot connect to the server.");if(b.isConnected||b.isDisconnected)b.isConnected?(this.isWorkerInitialized=!0,m.setReady()):this.onDisconnectedFromServer&&this.onDisconnectedFromServer();else{if(-2==b[0]){var c=b[1];return this.reusableArray[0]=b.buffer,this.worker.postMessage(b,this.reusableArray),void this.onLatencyUpdated(c)}var d=m.protocolsByProtocolID[b[0]];for(var e in d.buffer=b,d.parameters)d.getParameterFromBuffer(e);return d.onValuesReceived(),void d.onOwnershipReceived(b)}}.bind(this),this.worker.postMessage({serverURL:b})};var o=new n,p=function(a){this.wsLib=a,this.wsByClientID={},this.clientIDByWS=new Map};p.prototype.destroy=function(){for(var a in delete this.onClientConnected,delete this.onClientDisconnected,this.wsByClientID){var b=this.wsByClientID[a];b.terminate()}this.wsServer.close(),this.wsByClientID={},this.clientIDByWS=new Map,delete this.wsServer},p.prototype.sendProtocolToClient=function(a,b){var c=this.wsByClientID[a];if(!c)throw new Error("No such client: "+a);c.send(b.buffer)},p.prototype.init=function(b){this.wsServer=new this.wsLib.Server({port:b}),m.setReady(),this.wsServer.on("connection",function(b){var c=a();this.wsByClientID[c]=b,this.clientIDByWS.set(b,c),this.onClientConnected&&this.onClientConnected(c),b.on("message",function(a){var c=a.readFloatLE(0);if(0==c)b.send(a);else{for(var d=m.protocolsByProtocolID[c],e=4,f=1;f<d.buffer.length;f++)d.buffer[f]=a.readFloatLE(e),e+=4;for(var g in d.parameters)d.getParameterFromBuffer(g);d.onValuesReceived(this.clientID)}}.bind({clientID:c})),b.on("close",function(){var a=this.clientID,b=this.server;delete b.wsByClientID[a],b.clientIDByWS.delete(this.ws),this.server.onClientDisconnected&&this.server.onClientDisconnected(this.clientID)}.bind({clientID:c,server:this,ws:b}))}.bind(this))};var q=function(){this.IS_NODE="undefined"==typeof window};q.prototype.init=function(a){if(m.isReady)throw new Error("Rhubarb already initialized. Use destroy API first.");if(this._validateParameters(a),m.onReady=a.onReady,this.IS_NODE)return void this._initNode(a);var b=a.protocolDefinitionPath,c=a.workerPath,d=a.serverAddress,e=a.onError,f=new XMLHttpRequest;f.overrideMimeType("application/json"),f.open("GET",b,!0),f.onreadystatechange=function(){if(4==f.readyState&&"200"==f.status){var a;try{a=JSON.parse(f.responseText)}catch(a){return void e("Protocol definition file is not a valid JSON: "+a)}var b=k.parse(a);m.set(b),o.onError=e,this.initWorker(c,d)}else if(4==f.readyState)return void e("Protocol definition file not found.")}.bind({initWorker:this._initWorker}),f.send(null)},q.prototype.send=function(a,b,c){if(!m.isReady)throw new Error("Rhubarb is not initialized yet.");var d=m.protocolsByProtocolName[a];if(!d)throw new Error("No such protocol: "+a);for(var e in d.parameters){var f=b[e];if(f==null||null==f)throw new Error("Parameter value not defined: "+e);d.setParameterToBuffer(e,b[e])}this.IS_NODE?m.server.sendProtocolToClient(c,d):o.sendProtocol(d)},q.prototype.onReceived=function(a,b){if(!m.isReady)throw new Error("Rhubarb is not initialized yet.");var c=m.protocolsByProtocolName[a];if(!c)throw new Error("No such protocol: "+a);if(!b)throw new Error("Callback not defined.");if(!b instanceof Function)throw new Error("Callback is not a function.");c.onReceived=b},q.prototype.onDisconnectedFromServer=function(a){if(!m.isReady)throw new Error("Rhubarb is not initialized yet.");if(this.IS_NODE)throw new Error("This Rhubarb instance is a server.");if(!a)throw new Error("Callback not defined.");if(!a instanceof Function)throw new Error("Callback is not a function.");o.onDisconnectedFromServer=a},q.prototype.onClientConnected=function(a){if(!m.isReady)throw new Error("Rhubarb is not initialized yet.");if(!this.IS_NODE)throw new Error("This Rhubarb instance is not a server.");if(!a)throw new Error("Callback not defined.");if(!a instanceof Function)throw new Error("Callback is not a function.");m.server.onClientConnected=a},q.prototype.onClientDisconnected=function(a){if(!m.isReady)throw new Error("Rhubarb is not initialized yet.");if(!this.IS_NODE)throw new Error("This Rhubarb instance is not a server.");if(!a)throw new Error("Callback not defined.");if(!a instanceof Function)throw new Error("Callback is not a function.");m.server.onClientDisconnected=a},q.prototype.onLatencyUpdated=function(a){if(!m.isReady)throw new Error("Rhubarb is not initialized yet.");if(this.IS_NODE)throw new Error("This Rhubarb instance is a server.");if(!a)throw new Error("Callback not defined.");if(!a instanceof Function)throw new Error("Callback is not a function.");o.latencyCallback=a},q.prototype.destroy=function(){if(!m.isReady)throw new Error("Rhubarb not initialized. Use init API first.");this.IS_NODE?m.server.destroy():o.destroy(),m.destroy(),c.destroy(),k.destroy()},q.prototype._validateParameters=function(a){var b=a.protocolDefinitionPath,c=a.workerPath,d=a.isServer,e=a.serverAddress,f=a.serverListenPort,g=a.onReady,h=a.onError;if(!b)throw new Error("protocolDefinitionPath is not defined within parameters.");if(!this.IS_NODE&&!c)throw new Error("workerPath is not defined within parameters.");if(!this.IS_NODE&&d)throw new Error("Cannot use browser as a server.");if(d&&!f)throw new Error("serverListenPort is not defined within parameters.");if(!d&&!e)throw new Error("serverAddress is not defined within parameters.");if(!this.IS_NODE){if(!g)throw new Error("onReady is not defined within parameters.");if(!g instanceof Function)throw new Error("onReady parameter is not a Function.");if(!h)throw new Error("onError is not defined within parameters.");if(!h instanceof Function)throw new Error("onError parameter is not a Function.")}},q.prototype._initWorker=function(a,b){if(!this.IS_NODE&&"undefined"==typeof Worker)throw new Error("This browser does not support web workers.");else this.IS_NODE||o.initialize(a,b)},q.prototype._initNode=function(a){var b=a.protocolDefinitionPath,c=a.isServer,d=a.serverListenPort,e=require("fs");if(!e.existsSync(b))throw new Error("Protocol definition file does not exist.");var f,g=e.readFileSync(b,"utf8");try{f=JSON.parse(g)}catch(a){throw new Error("Protocol definition file is not a valid JSON: "+a)}var h=k.parse(f);m.set(h);var i=require("ws");if(c){var j=new p(i);j.init(d),m.setServer(j),m.setReady()}else throw new Error("NodeJS clients are not yet supported.")};var r=new q;return r});