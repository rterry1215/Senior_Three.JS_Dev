(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Kompute=e.Kompute||{})})(this,function(e){'use strict';var t=Math.cos,o=Math.floor,i=Math.sin,n=Number.EPSILON,a=Math.abs,p=Math.round,l=Math.sqrt,d=Math.max,c=Math.min,u=function(e,t,o){this.x=e||0,this.y=t||0,this.z=o||0};u.prototype.set=function(e,t,o){return this.x=e,this.y=t,this.z=o,this},u.prototype.copy=function(e){return this.set(e.x,e.y,e.z)},u.prototype.clone=function(){return new u().copy(this)},u.prototype.multiplyScalar=function(e){return this.set(this.x*e,this.y*e,this.z*e),this},u.prototype.min=function(e){return this.x=c(this.x,e.x),this.y=c(this.y,e.y),this.z=c(this.z,e.z),this},u.prototype.max=function(e){return this.x=d(this.x,e.x),this.y=d(this.y,e.y),this.z=d(this.z,e.z),this},u.prototype.getLength=function(){return l(this.x*this.x+this.y*this.y+this.z*this.z)},u.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},u.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},u.prototype.normalize=function(){var e=this.getLength();return 0==e?this:(this.x/=e,this.y/=e,this.z/=e,this)},u.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},u.prototype.applyQuaternion=function(e){var t=this.x,o=this.y,i=this.z,n=e.x,r=e.y,a=e.z,p=e.w,s=p*t+r*i-a*o,y=p*o+a*t-n*i,l=p*i+n*o-r*t,d=-n*t-r*o-a*i;return this.x=s*p+d*-n+y*-a-l*-r,this.y=y*p+d*-r+l*-n-s*-a,this.z=l*p+d*-a+s*-r-y*-n,this},u.prototype.cross=function(e){return this.set(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},u.prototype.negate=function(){return this.set(-this.x,-this.y,-this.z)},u.prototype.eql=function(e){return e.x==this.x&&e.y==this.y&&e.z==this.z},u.prototype.toFixed=function(e){return this.set(this.x.toFixed(e),this.y.toFixed(e),this.z.toFixed(e))},u.prototype.getDistanceSq=function(e){var t=this.x-e.x,o=this.y-e.y,i=this.z-e.z;return t*t+o*o+i*i};var g=function(e){this.index=0,this.vectors=[];for(var t=0;t<e;t++)this.vectors.push(new u)};g.prototype.get=function(){var e=this.vectors[this.index++];return this.index==this.vectors.length&&(this.index=0),e};var m=new g(10),h=function(){};h.prototype.clamp=function(e,t,o){return d(t,c(o,e))};var x=new g(10),v=function(e,t){this.min=new u,this.max=new u,this.setFromCenterAndSize(e,t)};v.prototype.setFromCenterAndSize=function(e,t){var o=x.get().copy(t).multiplyScalar(.5);return this.min.set(e.x-o.x,e.y-o.y,e.z-o.z),this.max.set(e.x+o.x,e.y+o.y,e.z+o.z),this},v.prototype.makeEmpty=function(){return this.min.set(1/0,1/0,1/0),this.max.set(-Infinity,-Infinity,-Infinity),this},v.prototype.expandByPoint=function(e){return this.min.min(e),this.max.max(e),this},v.prototype.intersectsBox=function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},v.prototype.containsBox=function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},v.prototype.setFromTwoVectors=function(e,t,o){this.makeEmpty(),this.expandByPoint(e),this.expandByPoint(t);var i=x.get().copy(e);return i.x=e.x+o,this.expandByPoint(i),i.x=e.x-o,this.expandByPoint(i),i.x=e.x,i.y=e.y+o,this.expandByPoint(i),i.y=e.y-o,this.expandByPoint(i),i.y=e.y,i.z=e.z+o,this.expandByPoint(i),i.z=e.z-o,this.expandByPoint(i),i.copy(t),i.x=t.x+o,this.expandByPoint(i),i.x=t.x-o,this.expandByPoint(i),i.x=t.x,i.y=t.y+o,this.expandByPoint(i),i.y=t.y-o,this.expandByPoint(i),i.y=t.y,i.z=t.z+o,this.expandByPoint(i),i.z=t.z-o,this.expandByPoint(i),this},v.prototype.isEmpty=function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},v.prototype.getBoundingRadius=function(){var e=x.get().set(0,0,0);return this.isEmpty()||e.copy(this.max).sub(this.min),.5*e.getLength()};var f=function(e,t,o,i){this.limitBox=this.createBox(0,0,0,e,t,o),this.binSize=i,this.bin=new Map,this.reusableResultMap=new Map};f.prototype.createBox=function(e,t,o,i,n,r){var a={};return a.containsBox=function(e){return this.minX<=e.minX&&e.maxX<=this.maxX&&this.minY<=e.minY&&e.maxY<=this.maxY&&this.minZ<=e.minZ&&e.maxZ<=this.maxZ},a.setFromCenterAndSize=function(e,t,o,i,n,r){var a=i/2,p=n/2,s=r/2;this.minX=e-a,this.maxX=e+a,this.minY=t-p,this.maxY=t+p,this.minZ=o-s,this.maxZ=o+s},a.setFromCenterAndSize(e,t,o,i,n,r),a},f.prototype.createObject=function(e,t){var o=this,i={id:e,box:t,binInfo:new Map};return i},f.prototype.insert=function(e){if(this.limitBox.containsBox(e.box)){var t,o,i=this.binSize,n=e.box,r=n.minX,a=n.minY,s=n.minZ,l=n.maxX,d=n.maxY,c=n.maxZ,u=p(r/i)*i;u<=r?(t=u,o=t+i):(o=u,t=u-i),u=p(l/i)*i;var g,m;u<l?(g=u,m=g+i):(m=u,g=u-i),t>g&&(g=t),u=p(a/i)*i;var h,v;u<=a?(h=u,v=h+i):(v=u,h=u-i),u=p(d/i)*i;var f,b;u<d?(f=u,b=f+i):(b=u,f=u-i),h>f&&(f=h),u=p(s/i)*i;var E,S;u<=s?(E=u,S=E+i):(S=u,E=u-i),u=p(c/i)*i;var D,P;u<c?(D=u,P=D+i):(P=u,D=u-i),E>D&&(D=E);for(var B=t;B<=g;B+=i)for(var w=h;w<=f;w+=i)for(var C=E;C<=D;C+=i)this.bin.has(B)||this.bin.set(B,new Map),this.bin.get(B).has(w)||this.bin.get(B).set(w,new Map),this.bin.get(B).get(w).has(C)||this.bin.get(B).get(w).set(C,new Map),this.bin.get(B).get(w).get(C).set(e,!0),e.binInfo.has(B)||e.binInfo.set(B,new Map),e.binInfo.get(B).has(w)||e.binInfo.get(B).set(w,new Map),e.binInfo.get(B).get(w).set(C,!0)}},f.prototype.query=function(e,t,o){var i,n,r=this.binSize,a=p(e/r)*r,s=p(t/r)*r,y=p(o/r)*r;a<=e?(i=a,n=a+r):(n=a,i=a-r);var l,d;s<=t?(l=s,d=s+r):(d=s,l=s-r);var c,u;y<=o?(c=y,u=y+r):(u=y,c=y-r);var g=this.reusableResultMap;g.clear();for(var m=-r;m<=r;m+=r)for(var h=-r;h<=r;h+=r)for(var x=-r;x<=r;x+=r){var v=i+m,f=l+h,b=c+x;if(this.bin.has(v)&&this.bin.get(v).has(f)){var z=this.bin.get(v).get(f).get(b);if(z){var E=!0,S=!1,D=void 0;try{for(var P,B,w=z.keys()[Symbol.iterator]();!(E=(P=w.next()).done);E=!0)B=P.value,g.set(B,!0)}catch(e){S=!0,D=e}finally{try{!E&&w.return&&w.return()}finally{if(S)throw D}}}}}return g},f.prototype.delete=function(e){var t=e.binInfo,o=!0,i=!1,n=void 0;try{for(var r,a=t.keys()[Symbol.iterator]();!(o=(r=a.next()).done);o=!0){var p=r.value,s=!0,l=!1,d=void 0;try{for(var c,u=t.get(p).keys()[Symbol.iterator]();!(s=(c=u.next()).done);s=!0){var g=c.value,y=!0,m=!1,h=void 0;try{for(var v,f,b=t.get(p).get(g).keys()[Symbol.iterator]();!(y=(v=b.next()).done);y=!0)f=v.value,this.bin.has(p)&&this.bin.get(p).has(g)&&this.bin.get(p).get(g).has(f)&&(this.bin.get(p).get(g).get(f).delete(e),0==this.bin.get(p).get(g).get(f).size&&this.bin.get(p).get(g).delete(f),0==this.bin.get(p).get(g).size&&this.bin.get(p).delete(g),0==this.bin.get(p).size&&this.bin.delete(p))}catch(e){m=!0,h=e}finally{try{!y&&b.return&&b.return()}finally{if(m)throw h}}}}catch(e){l=!0,d=e}finally{try{!s&&u.return&&u.return()}finally{if(l)throw d}}}}catch(e){i=!0,n=e}finally{try{!o&&a.return&&a.return()}finally{if(i)throw n}}var E=!0,S=!1,D=void 0;try{for(var P,p,B=t.keys()[Symbol.iterator]();!(E=(P=B.next()).done);E=!0)p=P.value,t.delete(p)}catch(e){S=!0,D=e}finally{try{!E&&B.return&&B.return()}finally{if(S)throw D}}},f.prototype.update=function(e,t,o,i,n,r,a){e.box.setFromCenterAndSize(t,o,i,n,r,a),this.delete(e),this.insert(e)};var b=new g(10),z=new h,E=function(e,t,o,i){this.set(e||0,t||0,o||0,i===void 0?1:i)};E.prototype.set=function(e,t,o,i){return this.x=e,this.y=t,this.z=o,this.w=i,this},E.prototype.copy=function(e){return this.set(e.x,e.y,e.z,e.w),this},E.prototype.clone=function(){return new E().copy(this)},E.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},E.prototype.radialDistanceTo=function(e){return 2*Math.acos(a(z.clamp(this.dot(e),-1,1)))},E.prototype.getLength=function(){return l(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},E.prototype.normalize=function(){var e=this.getLength();return 0==e?this.set(0,0,0,1):this.set(this.x/e,this.y/e,this.z/e,this.w/e)},E.prototype.sphericalLinearInterpolation=function(e,o){var t=Math.atan2;if(0==o)return this;if(1==o)return this.copy(e);var r=this.x,a=this.y,p=this.z,y=this.w,d=y*e.w+r*e.x+a*e.y+p*e.z;if(0>d?(this.set(-e.x,-e.y,-e.z,-e.w),d=-d):this.copy(e),1<=d)return this.set(r,a,p,y);var c=1-d*d;if(c<n){var u=1-o;return this.set(u*r+o*this.x,u*a+o*this.y,u*p+o*this.z,u*y+o*this.w).normalize()}var s=l(c),g=t(s,d),m=i((1-o)*g)/s,h=i(o*g)/s;return this.set(r*m+this.x*h,a*m+this.y*h,p*m+this.z*h,y*m+this.w*h)},E.prototype.rotateTowards=function(e,t){var o=this.radialDistanceTo(e);return 0==o?this:this.sphericalLinearInterpolation(e,c(1,t/o))},E.prototype.setFromVectors=function(e,t){var o=b.get().copy(e).normalize(),i=b.get().copy(t).normalize(),p=o.dot(i)+1;return p<n?a(o.x)>a(i.z)?this.set(-o.y,o.x,0,0):this.set(0,-o.z,o.y,0):this.set(o.y*i.z-o.z*i.y,o.z*i.x-o.x*i.z,o.x*i.y-o.y*i.x,p),this.normalize()};var S=new E,D=new E,P=new g(10),B=function(e,t,o){this.id=e,this.size=o,this.position=t.clone(),this.world=null,this.box=new v(t,o),this.nearbyObject=null,this.maxSpeed=1/0,this.velocity=new u,this.hasLookTarget=!1,this.lookTarget=new u,this.lookSpeed=.1,this.lookDirection=new u(0,0,-1)};B.prototype.update=function(){var e=this.velocity.getLength();e>this.maxSpeed&&this.velocity.copy(this.velocity.normalize().multiplyScalar(this.maxSpeed));var t=P.get().copy(this.velocity).multiplyScalar(1/60);if(this.setPosition(this.position.add(t)),this.hasLookTarget){var o=P.get().copy(this.lookTarget).sub(this.position),i=S.setFromVectors(this.lookDirection,o);D.set(0,0,0,1);var n=P.get().copy(this.lookDirection).applyQuaternion(D.rotateTowards(S,this.lookSpeed));this.setLookDirection(n)}},B.prototype.setPosition=function(e){this.position.copy(e),this.box.setFromCenterAndSize(e,this.size),this.world&&this.world.updateEntity(this,this.position,this.size)},B.prototype.setLookDirection=function(e){this.lookDirection.copy(P.get().copy(e).normalize()),this.world&&this.world.onLookDirectionUpdated(this)},B.prototype.executeForEachCloseEntity=function(e){if(this.world){var t=this.world.getNearbyObjects(this.position),o=!0,i=!1,n=void 0;try{for(var r,a,p=t[Symbol.iterator]();!(o=(r=p.next()).done);o=!0)if(a=r.value,a.id!=this.id&&e(this.world.getEntityByID(a.id)))return}catch(e){i=!0,n=e}finally{try{!o&&p.return&&p.return()}finally{if(i)throw n}}}},B.prototype.setLookTarget=function(e){this.lookTarget.copy(e),this.hasLookTarget=!0},B.prototype.unsetLookTarget=function(){this.hasLookTarget=!1},B.prototype.isNearTo=function(e){var t=!1;return this.executeForEachCloseEntity(function(o){if(o===e)return t=!0,!0}),t};var w=new u(1,1,1),C=function(e,t){var o=e.clone(),i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),o="x"==e?t:8|3&t;return o.toString(16)});B.call(this,"vertex#"+i,o,w),this.position=o,this.graph=t};C.prototype=Object.create(B.prototype),Object.defineProperty(C.prototype,"constructor",{value:C,enumerable:!1,writable:!0});var I=function(e,t,o,i){this.nearby=new f(e,t,o,i),this.entititesByID={},this.gravity=0};I.prototype.setGravity=function(e){this.gravity=e},I.prototype.getEntityByID=function(e){return this.entititesByID[e]||null},I.prototype.insertGraph=function(e){if(!e.world){var t=this;e.forEachVertex(function(o,i,n){var r=new C(new u(o,i,n),e);t.insertEntity(r),e.vertexIDs.push(r.id)}),e.world=this}},I.prototype.removeGraph=function(e){if(e.world){for(var t=0;t<e.vertexIDs.length;t++){var o=e.vertexIDs[t],n=this.getEntityByID(o);this.removeEntity(n)}e.world=null,e.vertexIDs=[]}},I.prototype.insertEntity=function(e){this.entititesByID[e.id]=e;var t=e.position,o=e.size,i=this.nearby.createBox(t.x,t.y,t.z,o.x,o.y,o.z),n=this.nearby.createObject(e.id,i);this.nearby.insert(n),e.world=this,e.nearbyObject=n,this.onEntityInserted&&this.onEntityInserted(e)},I.prototype.updateEntity=function(e,t,o){this.nearby.update(e.nearbyObject,t.x,t.y,t.z,o.x,o.y,o.z),this.onEntityUpdated&&this.onEntityUpdated(e)},I.prototype.onLookDirectionUpdated=function(e){this.onEntityLookDirectionUpdated&&this.onEntityLookDirectionUpdated(e)},I.prototype.removeEntity=function(e){delete this.entititesByID[e.id],this.nearby.delete(e.nearbyObject),this.onEntityRemoved&&this.onEntityRemoved(e)},I.prototype.getNearbyObjects=function(e){return this.nearby.query(e.x,e.y,e.z).keys()},I.prototype.forEachEntity=function(e){for(var t in this.entititesByID){var o=this.entititesByID[t];e(o)}};var T=function(e){if(e=e||{},this.index=0,this.length=0,this.jumpDescriptorLength=0,this.loop=!!e.loop,this.rewind=!!e.rewind,this.isRewinding=!1,this.isFinished=!1,this.waypoints=[],this.jumpDescriptors=[],e.fixedLength)for(var t=0;t<e.fixedLength;t++)this.waypoints.push(new u),this.jumpDescriptors.push(null);this.options=JSON.parse(JSON.stringify(e))};T.prototype.clone=function(){var e=new T(this.options);if(!this.options.fixedLength){for(var t=0;t<this.waypoints.length;t++)e.addWaypoint(this.waypoints[t]);for(var t=0;t<this.jumpDescriptors.length;t++)e.addJumpDescriptor(this.jumpDescriptors[t])}else{for(var t=0;t<this.length;t++)e.insertWaypoint(this.waypoints[t]);for(var t=0;t<this.jumpDescriptorLength;t++)e.insertJumpDescriptor(this.jumpDescriptors[t])}return e},T.prototype.restart=function(){this.isRewinding=!1,this.isFinished=!1,this.index=0},T.prototype.insertJumpDescriptor=function(e){this.jumpDescriptors[this.jumpDescriptorLength++]=e},T.prototype.addJumpDescriptor=function(e){var t=e.takeoffPosition,o=e.landingPosition,i=this.getWaypointIndex(t);if(null==i)return!1;var n=this.getWaypointIndex(o);return null!=n&&!(i>=n)&&(this.jumpDescriptors.push(e),this.jumpDescriptorLength++,!0)},T.prototype.getWaypointIndex=function(e){var t=this.length,o=this.waypoints.findIndex(function(o,i){return i<t&&o.eql(e)});return-1==o?null:o},T.prototype.insertWaypoint=function(e){this.waypoints[this.length++].copy(e)},T.prototype.addWaypoint=function(e){this.waypoints.push(e.clone()),this.length++},T.prototype.getCurrentWaypoint=function(){return!this.isFinished&&(this.waypoints[this.index]||!1)},T.prototype.onFinished=function(){this.finishCallback&&this.finishCallback()},T.prototype.next=function(){if(!this.isFinished){var e=this.length;this.isRewinding?(this.index--,-1==this.index&&(this.loop?(this.index=1,this.isRewinding=!1):(this.isFinished=!0,this.onFinished()))):(this.index++,this.index==e&&(this.rewind?(this.index=e-2,this.isRewinding=!0):this.loop?this.index=0:(this.isFinished=!0,this.onFinished())))}},T.prototype.getRandomWaypoint=function(){return this.waypoints[o(Math.random()*this.length)]||null};var k=function(e,t){this.fromVertex=e.clone(),this.toVertex=t.clone(),this.cost=e.clone().sub(t).getLength(),this.jumpDescriptor=null};k.prototype.clone=function(){return new k(this.fromVertex,this.toVertex)};var R=function(){this.world=null,this.connections={},this.totalVertexCount=0,this.vertexIDs=[]};R.prototype.clone=function(){var e=new R;return this.forEachVertex(function(t,o,i){e.addVertex(new u(t,o,i))}),this.forEachEdge(function(t){e.addEdge(t.fromVertex,t.toVertex)}),e},R.prototype.findClosestVertexToPoint=function(e){var t=this.world;if(!t)return null;var o=1/0,i=null,n=this.world.getNearbyObjects(e),r=!0,a=!1,p=void 0;try{for(var s,y=n[Symbol.iterator]();!(r=(s=y.next()).done);r=!0){var l=s.value,d=t.getEntityByID(l.id);if(d instanceof C&&d.graph===this){var c=e.getDistanceSq(d.position);c<o&&(i=d,o=c)}}}catch(e){a=!0,p=e}finally{try{!r&&y.return&&y.return()}finally{if(a)throw p}}return i?i.position:null},R.prototype.addVertex=function(e){if(this.hasVertex(e))return!1;var t=e.x,o=e.y,i=e.z;return this.connections[t]||(this.connections[t]={}),this.connections[t][o]||(this.connections[t][o]={}),this.connections[t][o][i]||(this.connections[t][o][i]=[]),this.totalVertexCount++,!0},R.prototype.removeVertex=function(e){if(!this.hasVertex(e))return!1;var t=e.x,o=e.y,n=e.z;for(var t in delete this.connections[t][o][n],0==Object.keys(this.connections[t][o]).length&&delete this.connections[t][o],0==Object.keys(this.connections[t]).length&&delete this.connections[t],this.connections)for(var o in this.connections[t])for(var n in this.connections[t][o]){for(var r=this.connections[t][o][n],a=-1,p=0;p<r.length;p++){var s=r[p],l=s.toVertex;if(l.x==e.x&&l.y==e.y&&l.z==e.z){a=p;break}}-1!=a&&(r.splice(a,1),this.connections[t][o][n]=r)}return this.totalVertexCount--,!0},R.prototype.hasVertex=function(e){var t=e.x,o=e.y,i=e.z;return!!(this.connections[t]&&this.connections[t][o]&&this.connections[t][o][i])},R.prototype.addEdge=function(e,t){if(!this.hasVertex(e)||!this.hasVertex(t))return!1;for(var o,n=this.connections[e.x][e.y][e.z],r=0;r<n.length;r++)if(o=n[r].toVertex,o.x==t.x&&o.y==t.y&&o.z==t.z)return!1;var a=new k(e,t);return n.push(a),!0},R.prototype.addJumpDescriptor=function(e){var t=e.takeoffPosition,o=e.landingPosition;if(!this.hasVertex(t)||!this.hasVertex(o))return!1;for(var n,r=this.connections[t.x][t.y][t.z],a=null,p=0;p<r.length;p++)if(n=r[p].toVertex,n.x==o.x&&n.y==o.y&&n.z==o.z){a=r[p];break}return a?a.jumpDescriptor=e:(a=new k(t,o),a.jumpDescriptor=e,r.push(a)),!0},R.prototype.removeEdge=function(e,t){if(!this.hasVertex(e)||!this.hasVertex(t))return!1;for(var o=this.connections[e.x][e.y][e.z],n=-1,r=0;r<o.length;r++){var a=o[r],p=a.toVertex;if(p.x==t.x&&p.y==t.y&&p.z==t.z){n=r;break}}return-1!=n&&(o.splice(n,1),this.connections[e.x][e.y][e.z]=o,!0)},R.prototype.forEachNeighbor=function(e,t){if(this.hasVertex(e))for(var o,n=this.connections[e.x][e.y][e.z],r=0;r<n.length;r++)o=n[r],t(o.toVertex,o.cost,o.jumpDescriptor)},R.prototype.forEachVertex=function(e){for(var t in this.connections)for(var o in this.connections[t])for(var i in this.connections[t][o])e(parseFloat(t),parseFloat(o),parseFloat(i))},R.prototype.forEachEdge=function(e){for(var t in this.connections)for(var o in this.connections[t])for(var n in this.connections[t][o])for(var r=this.connections[t][o][n],a=0;a<r.length;a++)e(r[a])};var L=function(e){this.data=[];for(var t=0;t<e;t++)this.data.push(null);this.length=0,this.HEAP_CHECK_RESULT_OK=0,this.HEAP_CHECK_RESULT_LEFT=1,this.HEAP_CHECK_RESULT_RIGHT=2};L.prototype.reset=function(){for(var e=0;e<this.data.length;e++)this.data[e]=null;this.length=0},L.prototype.peek=function(){return this.data[0]},L.prototype.getParentIndex=function(e){return o(e/2)},L.prototype.getLeftChildIndex=function(e){return this.getRightChildIndex(e)-1},L.prototype.getRightChildIndex=function(e){return 2*(e+1)},L.prototype.insert=function(e){if(this.data.length==this.length)return!1;var t=this.length,o=this.getParentIndex(this.length);this.data[t]=e;for(var i=this.data[o];i&&e.priority<i.priority;)this.data[o]=e,this.data[t]=i,t=o,o=this.getParentIndex(t),i=this.data[o];return this.length++,!0},L.prototype.remove=function(e){var t=this.data.indexOf(e);if(-1==t)return!1;var o=this.length-1;return this.swap(t,o),this.data[o]=null,this.length--,this.reconstruct(t),!0},L.prototype.heapCheck=function(e){var t=this.data[e];if(!t)return this.HEAP_CHECK_RESULT_OK;var o=this.getLeftChildIndex(e),i=this.getRightChildIndex(e),n=this.data[o],r=this.data[i];if(!n&&!r)return this.HEAP_CHECK_RESULT_OK;return r?t.priority<=n.priority&&t.priority<=r.priority?this.HEAP_CHECK_RESULT_OK:n.priority<=t.priority&&n.priority<=r.priority?this.HEAP_CHECK_RESULT_LEFT:this.HEAP_CHECK_RESULT_RIGHT:t.priority<=n.priority?this.HEAP_CHECK_RESULT_OK:this.HEAP_CHECK_RESULT_LEFT},L.prototype.swap=function(e,t){var o=this.data[e],i=this.data[t];this.data[e]=i,this.data[t]=o},L.prototype.pop=function(){if(0==this.length)return!1;var e=this.data[0],t=this.length-1;return this.data[0]=this.data[t],this.data[t]=null,this.length--,this.reconstruct(0),e},L.prototype.reconstruct=function(e){for(var t=this.heapCheck(e);t!=this.HEAP_CHECK_RESULT_OK;){if(t==this.HEAP_CHECK_RESULT_LEFT){var o=this.getLeftChildIndex(e);this.swap(e,o),e=o}else{var i=this.getRightChildIndex(e);this.swap(e,i),e=i}t=this.heapCheck(e)}},L.prototype.hasNode=function(e){return 0<=this.data.indexOf(e)};var j=new g(10),A=function(e){var t=new T({fixedLength:e.totalVertexCount}),o={};e.forEachVertex(function(e,t,i){o[e]||(o[e]={}),o[e][t]||(o[e][t]={}),o[e][t][i]||(o[e][t][i]={priority:0,parent:null,x:parseFloat(e),y:parseFloat(t),z:parseFloat(i),closedTag:null,parentTag:null,jumpDescriptor:null})}),this.heapNodes=o,this.path=t,this.graph=e,this.heap=new L(e.totalVertexCount),this.searchID=0};A.prototype.getHeapNode=function(e,t,o,i){var n=i?i[e]:this.heapNodes[e];if(n){var r=n[t];return r?r[o]||null:null}return null},A.prototype.isNodeBelongToVector=function(e,t){return e===this.getHeapNode(t.x,t.y,t.z)},A.prototype.generatePath=function(e){var t=this.path;t.length=0;for(var o=e,i=this.getHeapNode(o.x,o.y,o.z);i;){t.insertWaypoint(o);var n=i.jumpDescriptor;n&&t.insertJumpDescriptor(n);var r=i.parentTag;i=i.parent,i&&r!=this.searchID&&(i=null),i&&(o=j.get().set(i.x,i.y,i.z))}return t.isRewinding=!0,t.index=t.length-1,t.isFinished=!1,t},A.prototype.markNodeAsClosed=function(e,t){e.closedTag=t},A.prototype.isNodeClosed=function(e,t){return e.closedTag===t},A.prototype.findShortestPath=function(e,t){var o=this.heapNodes;this.searchID++;var i=this.searchID,n=this.heap;n.reset();var r=this.graph;if(!r.hasVertex(e)||!r.hasVertex(t))return!1;var a=this.getHeapNode,p=this.isNodeClosed,s=this.markNodeAsClosed,y=this.getHeapNode(e.x,e.y,e.z),l=j.get();for(n.insert(y);y;){if(this.isNodeBelongToVector(y,t))return this.generatePath(t);s(y,i),l.set(y.x,y.y,y.z),r.forEachNeighbor(l,function(e,r,l){var d=a(e.x,e.y,e.z,o),c=e.getDistanceSq(t);if(p(d,i)||(d.priority=r+c,d.parent=y,d.parentTag=i,d.jumpDescriptor=l,s(d,i),n.insert(d)),n.hasNode(d)){var u=c+r;u<d.priority&&(d.priority=u,d.parent=y,d.parentTag=i,d.jumpDescriptor=l,n.remove(d),n.insert(d))}}),y=n.pop()}return!1};var M=function(){this.logMethod=console.log,this.isEnabled=!1,this.lastMessageMap={}};M.prototype.enable=function(){this.isEnabled=!0},M.prototype.disable=function(){this.isEnabled=!1},M.prototype.log=function(e,t,o){this.isEnabled&&this.lastMessageMap[o]!=t&&(this.logMethod("["+e+"]: "+t+" ("+o+")"),this.lastMessageMap[o]=t)};var J=new M,V="Steerable",F=1/60,H=new g(10),N=function(e,t,o){B.call(this,e,t,o),this.hasTargetPosition=!1,this.hasTargetEntity=!1,this.hasHideTargetEntity=!1,this.targetPosition=new u,this.targetEntity=null,this.hideTargetEntity=null,this.linearAcceleration=new u,this.maxAcceleration=1/0,this.isJumpInitiated=!1,this.isJumpReady=!1,this.isJumpTakenOff=!1,this.jumpSpeed=1/0,this.jumpTime=0};N.prototype=Object.create(B.prototype),N.prototype.update=function(){if(!this.world)return void J.log(V,"Not inserted to a world.",this.id);if(!this.behavior)return void J.log(V,"Has no behavior.",this.id);var e=this.behavior.compute(this);this.linearAcceleration.copy(e.linear);var t=this.linearAcceleration.getLength();t>this.maxAcceleration&&this.linearAcceleration.copy(this.linearAcceleration.normalize().multiplyScalar(this.maxAcceleration)),this.isJumpTakenOff&&(this.linearAcceleration.y+=this.world.gravity,this.jumpTime+=F,this.jumpTime>=this.jumpDescriptor.getEquationResult(this).time&&(J.log(V,"Jump completed.",this.id),this.onJumpCompleted()));var o=H.get().copy(this.linearAcceleration).multiplyScalar(F);if(this.velocity.add(o),B.prototype.update.call(this),this.isJumpInitiated&&!this.isJumpTakenOff&&!this.isJumpReady){var i=H.get().copy(this.position).sub(this.jumpDescriptor.takeoffPosition).getLength();i<this.jumpDescriptor.runupSatisfactionRadius&&(J.log(V,"Jump ready.",this.id),this.onJumpReady())}},N.prototype.setJumpBehavior=function(e){this.isJumpInitiated||(this.jumpBehavior=e)},N.prototype.setBehavior=function(e){this.isJumpInitiated||(this.behavior=e)},N.prototype.unsetTargetPosition=function(){this.isJumpInitiated||(this.hasTargetPosition=!1)},N.prototype.setTargetPosition=function(e){this.isJumpInitiated||(this.targetPosition.copy(e),this.hasTargetPosition=!0)},N.prototype.setTargetEntity=function(e){this.isJumpInitiated||(this.targetEntity=e,this.hasTargetEntity=!0)},N.prototype.unsetTargetEntity=function(){this.isJumpInitiated||(this.hasTargetEntity=!1,this.targetEntity=null)},N.prototype.setHideTargetEntity=function(e){this.isJumpInitiated||(this.hideTargetEntity=e,this.hasHideTargetEntity=!0)},N.prototype.unsetHideTargetEntity=function(){this.isJumpInitiated||(this.hasHideTargetEntity=!1,this.hideTargetEntity=null)},N.prototype.jump=function(e,t){var o=t.solveQuadraticEquation(this);return o?(this.isJumpInitiated=!1,this.isJumpReady=!1,this.isJumpTakenOff=!1,this.unsetTargetEntity(),this.unsetHideTargetEntity(),this.setTargetPosition(t.takeoffPosition),this.setBehavior(e),this.jumpDescriptor=t,this.isJumpInitiated=!0,this.jumpTime=0,J.log(V,"Jump initiated.",this.id),!0):(J.log(V,"Equation cannot be solved.",this.id),!1)},N.prototype.onJumpReady=function(){this.isJumpReady=!0,this.isJumpInitiated=!1,this.setBehavior(this.jumpBehavior),this.isJumpInitiated=!0,this.jumpBehavior||J.log(V,"No jump behavior set.",this.id)},N.prototype.onJumpTakeOff=function(){this.isJumpTakenOff=!0;var e=this.jumpDescriptor,t=e.getEquationResult(this);this.velocity.set(t.vx,this.jumpSpeed,t.vz)},N.prototype.onJumpCompleted=function(){this.jumpTime=0,this.isJumpInitiated=!1,this.isJumpReady=!1,this.isJumpTakenOff=!1,this.position.y=this.jumpDescriptor.landingPosition.y,this.velocity.set(0,0,0),this.linearAcceleration.set(0,0,0),this.jumpCompletionCallback&&this.jumpCompletionCallback(this)},N.prototype.setJumpCompletionListener=function(e){this.jumpCompletionCallback=e},N.prototype.removeJumpCompletionListener=function(){this.jumpCompletionCallback=null},Object.defineProperty(N.prototype,"constructor",{value:N,enumerable:!1,writable:!0});var _=function(){this.linear=new u},O=function(e){this.takeoffPosition=e.takeoffPosition.clone(),this.landingPosition=e.landingPosition.clone(),this.runupSatisfactionRadius=e.runupSatisfactionRadius,this.takeoffPositionSatisfactionRadius=e.takeoffPositionSatisfactionRadius,this.takeoffVelocitySatisfactionRadius=e.takeoffVelocitySatisfactionRadius,this.delta=this.landingPosition.clone().sub(this.takeoffPosition),this.checkTimeResult={vx:0,vz:0,isAchievable:!1},this.cache={}};O.prototype.getEquationResult=function(e){var t=e.jumpSpeed,o=e.maxSpeed,i=e.world.gravity,n=this.cache;return n[t]&&n[t][o]&&n[t][o][i]?n[t][o][i]:null},O.prototype.setCache=function(e,t){var o=e.jumpSpeed,i=e.maxSpeed,n=e.world.gravity,r=this.cache;r[o]||(r[o]={}),r[o][i]||(r[o][i]={}),r[o][i][n]||(r[o][i]={}),r[o][i][n]=t},O.prototype.solveQuadraticEquation=function(e){var t=this.getEquationResult(e);if(t)return t;t={time:0,vx:0,vz:0,isAchievable:!1},this.setCache(e,t),t.isAchievable=!1;var o=e.jumpSpeed,i=e.maxSpeed,n=e.world,r=n.gravity,a=2*r*this.delta.y+o*o,p=l(a),s=(-o+p)/r,y=this.checkTime(s,i);return t.time=s,t.vx=y.vx,t.vz=y.vz,t.isAchievable=y.isAchievable,y.isAchievable||(s=(-o-p)/r,y=this.checkTime(s,i),t.time=s,t.vx=y.vx,t.vz=y.vz,t.isAchievable=y.isAchievable),!!t.isAchievable&&t},O.prototype.checkTime=function(e,t){this.checkTimeResult.isAchievable=!1;var o=this.delta.x/e,i=this.delta.z/e;return o*o+i*i<=t*t&&(this.checkTimeResult.isAchievable=!0,this.checkTimeResult.vx=o,this.checkTimeResult.vz=i),this.checkTimeResult};var W=function(){this.result=new _};W.prototype.compute=function(){return this.result.linear.set(0,0,0),this.result};var K=function(){W.call(this)};K.prototype=Object.create(W.prototype),K.prototype.compute=function(e){return(this.result.linear.set(0,0,0),!e.hasTargetPosition)?(J.log("SeekBehavior","No target position.",e.id),this.result):(this.result.linear.copy(e.targetPosition).sub(e.position).normalize().multiplyScalar(e.maxAcceleration),J.log("SeekBehavior","Speeding up.",e.id),this.result)},Object.defineProperty(K.prototype,"constructor",{value:K,enumerable:!1,writable:!0});var U=new g(10),q="ArriveBehavior",G=function(e){W.call(this),this.satisfactionRadius=e.satisfactionRadius,this.slowDownRadius=e.slowDownRadius};G.prototype=Object.create(W.prototype),G.prototype.compute=function(e){if(this.result.linear.set(0,0,0),!e.hasTargetPosition)return J.log(q,"Steerable has no target position.",e.id),this.result;var t=U.get().copy(e.targetPosition).sub(e.position),o=t.getLength(),i=U.get().set(0,0,0);return o<=this.satisfactionRadius?(J.log(q,"Arrived.",e.id),this.result):(i.copy(t).normalize().multiplyScalar(e.maxSpeed),o<=this.slowDownRadius?(J.log(q,"Slowing down.",e.id),i.multiplyScalar(o/this.slowDownRadius)):J.log(q,"Speeding up.",e.id),this.result.linear.copy(i).sub(e.velocity),this.result)},Object.defineProperty(G.prototype,"constructor",{value:G,enumerable:!1,writable:!0});var Y=new v(new u(),new u()),X=new g(10),Z="AvoidBehavior",Q=function(e){W.call(this),this.maxSeeAhead=e.maxSeeAhead,this.maxAvoidForce=e.maxAvoidForce};Q.prototype=Object.create(W.prototype),Q.prototype.findMostThreateningObstacle=function(e){var t=null,o=this.maxSeeAhead,i=e.position,n=X.get().copy(e.velocity);n.normalize().multiplyScalar(o);var r=X.get().copy(n).add(i);return Y.setFromTwoVectors(i,r,.001),Y.expandByPoint(e.box.min),Y.expandByPoint(e.box.max),e.executeForEachCloseEntity(function(e){if(Y.intersectsBox(e.box))if(!t)t=e;else{var o=X.get().copy(i).sub(e.position).getLength(),n=X.get().copy(i).sub(t.position).getLength();o<=n&&(t=e)}}),t},Q.prototype.compute=function(e){this.result.linear.set(0,0,0);var t=this.findMostThreateningObstacle(e);return t?(J.log(Z,"Threatening entity found.",e.id),this.result.linear.copy(e.velocity).normalize().multiplyScalar(e.velocity.getLength()/e.maxSpeed).add(e.position).sub(t.position).normalize().multiplyScalar(this.maxAvoidForce),this.result):(J.log(Z,"No threatening entity found.",e.id),this.result)},Object.defineProperty(Q.prototype,"constructor",{value:Q,enumerable:!1,writable:!0});var $=new g(10),ee=function(e){W.call(this),this.definitions=e};ee.prototype=Object.create(W.prototype),ee.prototype.compute=function(e){this.result.linear.set(0,0,0);for(var t=0;t<this.definitions.length;t++){var o=this.definitions[t],n=o.behavior,r=o.weight,a=n.compute(e);a&&this.result.linear.add($.get().copy(a.linear).multiplyScalar(r))}return this.result},Object.defineProperty(ee.prototype,"constructor",{value:ee,enumerable:!1,writable:!0});var te=new g(10),oe=function(e){K.call(this),this.maxPredictionTime=e.maxPredictionTime};oe.prototype=Object.create(K.prototype),oe.prototype.compute=function(e){if(this.result.linear.set(0,0,0),!e.hasTargetEntity)return J.log("PursueBehavior","Entity has no target entity.",e.id),this.result;var t=e.targetEntity,o=t.position,i=e.velocity.getLength(),n=this.maxPredictionTime;if(0<i){var r=te.get().copy(o).sub(e.position).getLength(),a=r/i;a<this.maxPredictionTime&&(n=a)}var p=te.get().copy(t.velocity).multiplyScalar(n).add(o);return e.setTargetPosition(p),J.log("PursueBehavior","Seeking.",e.id),K.prototype.compute.call(this,e)},Object.defineProperty(oe.prototype,"constructor",{value:K,enumerable:!1,writable:!0});var ie=new g(10),ne=function(){W.call(this)};ne.prototype=Object.create(W.prototype),ne.prototype.compute=function(e){this.result.linear.set(0,0,0);var t=ie.get().copy(e.position).add(e.velocity);return e.setLookTarget(t),this.result},Object.defineProperty(ne.prototype,"constructor",{value:ne,enumerable:!1,writable:!0});var re=new g(10),ae=new E,pe=function(e){W.call(this),this.normal=e.normal.clone().normalize(),this.wanderCircleDistance=e.wanderCircleDistance,this.wanderCircleRadius=e.wanderCircleRadius,this.angleChange=e.angleChange,this.angle=0};pe.prototype=Object.create(W.prototype),pe.prototype.compute=function(e){var t=this.getCircleCenter(e),o=this.getDisplacementForce();return this.result.linear.copy(t).add(o),this.angle+=Math.random()*this.angleChange-.5*this.angleChange,this.result},pe.prototype.getCircleCenter=function(e){var t=this.wanderCircleDistance;return re.get().copy(e.velocity).normalize().multiplyScalar(t)},pe.prototype.getDisplacementForce=function(){var e=re.get().set(0,0,0);e.x=t(this.angle),e.z=i(this.angle),e.normalize().multiplyScalar(this.wanderCircleRadius);var o=ae.setFromVectors(re.get().set(0,1,0),this.normal);return e.applyQuaternion(o),e},Object.defineProperty(pe.prototype,"constructor",{value:pe,enumerable:!1,writable:!0});var se=new g(10),ye=function(e){pe.call(this,{wanderCircleDistance:e.wanderSphereDistance,angleChange:e.angleChange,normal:new u}),this.angle2=0,this.wanderSphereRadius=e.wanderSphereRadius};ye.prototype=Object.create(pe.prototype),ye.prototype.compute=function(e){var t=this.getCircleCenter(e),o=this.getDisplacementForce();return this.result.linear.copy(t).add(o),this.angle+=Math.random()*this.angleChange-.5*this.angleChange,this.angle2+=Math.random()*this.angleChange-.5*this.angleChange,this.result},ye.prototype.getDisplacementForce=function(){var e=se.get().set(0,0,0);return e.x=i(this.angle)*t(this.angle2),e.y=i(this.angle)*i(this.angle2),e.z=t(this.angle),e.normalize().multiplyScalar(this.wanderSphereRadius)},Object.defineProperty(ye.prototype,"constructor",{value:ye,enumerable:!1,writable:!0});var le=function(){K.call(this)};le.prototype=Object.create(K.prototype),le.prototype.compute=function(e){return K.prototype.compute.call(this,e),this.result.linear.negate(),this.result},Object.defineProperty(le.prototype,"constructor",{value:le,enumerable:!1,writable:!0});var de=function(e){oe.call(this,e)};de.prototype=Object.create(oe.prototype),de.prototype.compute=function(e){return oe.prototype.compute.call(this,e),this.result.linear.negate(),this.result},Object.defineProperty(de.prototype,"constructor",{value:de,enumerable:!1,writable:!0});var ce=new g(10),ue="PathFollowingBehavior",ge=function(e){K.call(this),this.path=e.path,this.satisfactionRadius=e.satisfactionRadius||0,this.onJumpCompletionCallback=this.onJumpCompleted.bind(this)};ge.prototype=Object.create(K.prototype),ge.prototype.getNext=function(){var e=this.path;return e.next(),e.getCurrentWaypoint()},ge.prototype.getCurrentWaypoint=function(){return this.path.getCurrentWaypoint()},ge.prototype.compute=function(e){this.result.linear.set(0,0,0);var t=this.path,o=this.getCurrentWaypoint();if(!o)return J.log(ue,"No waypoint.",e.id),this.result;var i=this.isJumpNeeded(e);if(i)return this.beforeJumpBehavior=e.behavior,e.jumpDescriptor=i,e.onJumpReady(),e.setJumpCompletionListener(this.onJumpCompletionCallback),J.log(ue,"Jump initiated.",e.id),this.result;var n=ce.get().copy(o).sub(e.position).getLength();return n<=this.satisfactionRadius&&(o=this.getNext(),J.log(ue,"Next waypoint.",e.id),!o)?(J.log(ue,"Path completed.",e.id),this.result):(e.setTargetPosition(o),K.prototype.compute.call(this,e))},ge.prototype.isJumpNeeded=function(e){for(var t=this.path,o=t.jumpDescriptors,n=0;n<t.jumpDescriptorLength;n++){var r=o[n],a=ce.get().copy(e.position).sub(r.takeoffPosition).getLength();if(a<r.runupSatisfactionRadius){var p=r.solveQuadraticEquation(e);if(p)return r}}return!1},ge.prototype.onJumpCompleted=function(e){for(var t=e.jumpDescriptor,o=t.landingPosition,i=this.path,n=i.getWaypointIndex(o);i.index!=n&&!i.isFinished;)i.next();e.setBehavior(this.beforeJumpBehavior)},Object.defineProperty(ge.prototype,"constructor",{value:ge,enumerable:!1,writable:!0});var me=function(e){W.call(this),this.threshold=e.threshold,this.list=e.list};me.prototype=Object.create(W.prototype),me.prototype.compute=function(e){this.result.linear.set(0,0,0);for(var t,o=0;o<this.list.length;o++)if(t=this.list[o].compute(e),t.linear.getLength()>this.threshold)return this.result.linear.copy(t.linear),J.log("PrioritySteeringBehavior","Computed.",e.id),this.result;return J.log("PrioritySteeringBehavior","Not computed.",e.id),this.result},Object.defineProperty(me.prototype,"constructor",{value:me,enumerable:!1,writable:!0});var he=new g(10),xe="HideBehavior",ve=function(e){G.call(this,{satisfactionRadius:e.arriveSatisfactionRadius,slowDownRadius:e.arriveSlowDownRadius}),this.hideDistance=e.hideDistance,this.threatDistance=e.threatDistance,this.hidingSpotFound=!1,this.bestHidingSpot=new u};ve.prototype=Object.create(G.prototype),ve.prototype.compute=function(e){return(this.result.linear.set(0,0,0),!e.hideTargetEntity)?(J.log(xe,"No hide target entity set.",e.id),this.result):he.get().copy(e.position).sub(e.hideTargetEntity.position).getLength()>this.threatDistance?(J.log(xe,"Target entity is out of threat distance.",e.id),this.result):(this.findHidingSpot(e),!this.hidingSpotFound)?(J.log(xe,"No hiding spot found.",e.id),this.result):(J.log(xe,"Hiding.",e.id),e.setTargetPosition(this.bestHidingSpot),G.prototype.compute.call(this,e))},ve.prototype.findHidingSpot=function(e){this.hidingSpotFound=!1;var t=null,o=this;e.executeForEachCloseEntity(function(i){if(!(i instanceof N)){var n=o.getHidingPosition(i,e),r=he.get().copy(n).sub(e.position).getLength();(null==t||r<t)&&(t=r,o.hidingSpotFound=!0,o.bestHidingSpot.copy(n))}})},ve.prototype.getHidingPosition=function(e,t){var o=t.hideTargetEntity.position,i=e.box.getBoundingRadius(),n=i+this.hideDistance,r=e.position;return he.get().copy(r).sub(o).normalize().multiplyScalar(n).add(r)},Object.defineProperty(ve.prototype,"constructor",{value:ve,enumerable:!1,writable:!0});var fe=function(e){ge.call(this,e)};fe.prototype=Object.create(ge.prototype),fe.prototype.getNext=function(){var e=this.path;return this.currentWayPoint=e.getRandomWaypoint(),this.currentWayPoint},fe.prototype.getCurrentWaypoint=function(){return this.currentWayPoint?this.currentWayPoint:this.getNext()},Object.defineProperty(fe.prototype,"constructor",{value:fe,enumerable:!1,writable:!0});var be=new g(10),ze=function(e){W.call(this),this.strength=e.strength};ze.prototype=Object.create(W.prototype),ze.prototype.compute=function(e){var t=this.result.linear;t.set(0,0,0);var o=this.strength;return e.executeForEachCloseEntity(function(i){if(i instanceof N){var n=be.get().copy(e.position).sub(i.position),r=n.getLength();0==r||(n.normalize().multiplyScalar(o/r),t.add(n))}}),this.result},Object.defineProperty(ze.prototype,"constructor",{value:ze,enumerable:!1,writable:!0});var Ee=function(){W.call(this)};Ee.prototype=Object.create(W.prototype),Ee.prototype.compute=function(e){var t=this.result.linear;t.set(0,0,0);var o=0;return e.executeForEachCloseEntity(function(e){e instanceof N&&(t.add(e.velocity),o++)}),0<o?(t.multiplyScalar(1/o),t.sub(e.velocity),J.log("AlignBehavior","Close entities exist.",e.id)):J.log("AlignBehavior","No close entities exist.",e.id),this.result},Object.defineProperty(Ee.prototype,"constructor",{value:Ee,enumerable:!1,writable:!0});var Se=function(){K.call(this)};Se.prototype=Object.create(K.prototype),Se.prototype.compute=function(e){var t=this.result.linear;t.set(0,0,0);var o=0;return(e.executeForEachCloseEntity(function(e){e instanceof N&&(t.add(e.position),o++)}),0<o)?(J.log("CohesionBehavior","Close entities exist.",e.id),t.multiplyScalar(1/o),e.setTargetPosition(t),K.prototype.compute.call(this,e)):(J.log("CohesionBehavior","No close entities exist.",e.id),this.result)},Object.defineProperty(Se.prototype,"constructor",{value:Se,enumerable:!1,writable:!0});var De=new g(10),Pe="JumpBehavior",Be=function(){W.call(this)};Be.prototype=Object.create(W.prototype),Be.prototype.compute=function(e){var t=this.result.linear;if(t.set(0,0,0),!e.isJumpReady)return J.log(Pe,"Jump not ready.",e.id),this.result;if(e.isJumpTakenOff)return J.log(Pe,"Jump already took off.",e.id),this.result;var o=e.jumpDescriptor,i=o.getEquationResult(e);if(0==i.time)return J.log(Pe,"Equation result time is zero.",e.id),this.result;var n=De.get().set(i.vx,0,i.vz),r=De.get().copy(e.position).sub(o.takeoffPosition).getLength();if(r<=o.takeoffPositionSatisfactionRadius){var a=De.get().copy(e.velocity).sub(n).getLength();if(a<=o.takeoffVelocitySatisfactionRadius)return e.onJumpTakeOff(),J.log(Pe,"Taking off.",e.id),this.result}return J.log(Pe,"Matching velocity.",e.id),this.matchVelocity(i.time,n,e)},Be.prototype.matchVelocity=function(e,t,o){var i=this.result.linear;return t.sub(o.velocity).multiplyScalar(1/e),i.copy(t),this.result},Object.defineProperty(Be.prototype,"constructor",{value:Be,enumerable:!1,writable:!0});var we=function(e){var t=e.graph,o=new A(t),i=[];t.forEachVertex(function(e,t,o){i.push(new u(e,t,o))}),ge.call(this,{path:o.path,satisfactionRadius:e.satisfactionRadius}),this.aStar=o,this.allVertices=i,this.isPathConstructed=!1,o.path.finishCallback=function(){this.isPathConstructed=!1}.bind(this)};we.prototype=Object.create(ge.prototype),we.prototype.getRandomWaypoint=function(){var e=this.allVertices;return e[o(Math.random()*e.length)]||null},we.prototype.constructPath=function(e){for(var t=!0,o=this.aStar,i=o.graph;t;){var n=i.findClosestVertexToPoint(e.position);n||(n=this.getRandomWaypoint());var r=this.getRandomWaypoint(),a=o.findShortestPath(n,r);t=!a}this.isPathConstructed=!0},we.prototype.compute=function(e){return this.isPathConstructed||(J.log("RandomPathBehavior","Path constructed.",e.id),this.constructPath(e)),J.log("RandomPathBehavior","Following path.",e.id),ge.prototype.compute.call(this,e)},Object.defineProperty(we.prototype,"constructor",{value:we,enumerable:!1,writable:!0});var Ce=new v(new u(),new u()),Ie=new u,Te=function(e,t,o){this.world=e,this.threeInstance=t,this.scene=o,this.isActive=!1,this.limeMaterial=new t.MeshBasicMaterial({color:"lime",wireframe:!0}),this.magentaMaterial=new t.MeshBasicMaterial({color:"magenta",wireframe:!0}),this.redMaterial=new t.MeshBasicMaterial({color:"red",wireframe:!1}),this.orangeMaterial=new t.MeshBasicMaterial({color:"orange",wireframe:!1}),this.lineMaterial=new t.LineBasicMaterial({color:"cyan"}),this.meshesByEntityID={},this.velocityMeshesByEntityID={},this.lookMeshesByEntityID={},this.pathMeshes=[],this.edgeMeshes=[],this.LOOK_DISTANCE=100,this.world.onEntityInserted=function(e){this.isActive&&this.addEntity(e)}.bind(this),this.world.onEntityRemoved=function(e){if(this.isActive){var t=this.meshesByEntityID[e.id];if(this.scene.remove(t),delete this.meshesByEntityID[e.id],e instanceof N){var o=this.velocityMeshesByEntityID[e.id];this.scene.remove(o),delete this.velocityMeshesByEntityID[e.id];var i=this.lookMeshesByEntityID[e.id];this.scene.remove(i),delete this.lookMeshesByEntityID[e.id]}}}.bind(this),this.world.onEntityUpdated=function(e){if(this.isActive){var t=this.meshesByEntityID[e.id];if(t.position.set(e.position.x,e.position.y,e.position.z),e instanceof N){var o=this.velocityMeshesByEntityID[e.id];Ie.copy(e.position).add(e.velocity),Ce.setFromTwoVectors(e.position,Ie,5),Ie.x=(Ie.x+e.position.x)/2,Ie.y=(Ie.y+e.position.y)/2,Ie.z=(Ie.z+e.position.z)/2,o.position.set(Ie.x,Ie.y,Ie.z),o.scale.set(Ce.max.x-Ce.min.x,Ce.max.y-Ce.min.y,Ce.max.z-Ce.min.z);var i=this.lookMeshesByEntityID[e.id];Ie.copy(e.lookDirection).normalize().multiplyScalar(this.LOOK_DISTANCE).add(e.position),i.position.set(Ie.x,Ie.y,Ie.z)}}}.bind(this),this.world.onEntityLookDirectionUpdated=function(e){if(this.isActive&&e instanceof N){var t=this.lookMeshesByEntityID[e.id];Ie.copy(e.lookDirection).normalize().multiplyScalar(this.LOOK_DISTANCE).add(e.position),t.position.set(Ie.x,Ie.y,Ie.z)}}.bind(this)};Te.prototype.visualisePath=function(e){for(var t=0;t<e.waypoints.length;t++){var o=e.waypoints[t],n=new this.threeInstance.Mesh(new this.threeInstance.BoxBufferGeometry(5,5,5),this.orangeMaterial);n.position.set(o.x,o.y,o.z),this.scene.add(n),this.pathMeshes.push(n)}},Te.prototype.visualiseGraph=function(e){var t=this.threeInstance,o=this.lineMaterial,i=this.scene,n=this.edgeMeshes;e.forEachEdge(function(e){var r=new t.Geometry;r.vertices.push(e.fromVertex),r.vertices.push(e.toVertex);var a=new t.Line(r,o);i.add(a),n.push(a)})},Te.prototype.addEntity=function(e){var t=this.createMeshFromEntity(e);if(this.meshesByEntityID[e.id]=t,this.scene.add(t),e instanceof N){var o=new this.threeInstance.Mesh(new this.threeInstance.BoxBufferGeometry(1,1,1),this.magentaMaterial);o.position.set(e.position.x,e.position.y,e.position.z),this.scene.add(o),this.velocityMeshesByEntityID[e.id]=o;var i=new this.threeInstance.Mesh(new this.threeInstance.BoxBufferGeometry(5,5,5),this.redMaterial),n=new u().copy(e.lookDirection).normalize().add(e.position).multiplyScalar(this.LOOK_DISTANCE);i.position.set(n.x,n.y,n.z),this.scene.add(i),this.lookMeshesByEntityID[e.id]=i}},Te.prototype.activate=function(){this.isActive=!0,this.world.forEachEntity(function(e){this.addEntity(e)}.bind(this))},Te.prototype.deactivate=function(){for(var e in this.isActive=!1,this.meshesByEntityID)this.scene.remove(this.meshesByEntityID[e]);for(var e in this.velocityMeshesByEntityID)this.scene.remove(this.velocityMeshesByEntityID[e]);for(var e in this.lookMeshesByEntityID)this.scene.remove(this.lookMeshesByEntityID[e]);for(var t=0;t<this.pathMeshes.length;t++)this.scene.remove(this.pathMeshes[t]);for(var t=0;t<this.edgeMeshes.length;t++)this.scene.remove(this.edgeMeshes[t]);this.meshesByEntityID={},this.velocityMeshesByEntityID={},this.lookMeshesByEntityID={},this.pathMeshes=[],this.edgeMeshes=[]},Te.prototype.createMeshFromEntity=function(e){var t=new this.threeInstance.BoxBufferGeometry(e.size.x,e.size.y,e.size.z),o=new this.threeInstance.Mesh(t,this.limeMaterial);return o.position.set(e.position.x,e.position.y,e.position.z),o},e.MathUtils=h,e.Vector3D=u,e.VectorPool=g,e.Box=v,e.World=I,e.Entity=B,e.Quaternion=E,e.Path=T,e.Edge=k,e.Graph=R,e.MinHeap=L,e.AStar=A,e.Vertex=C,e.Steerable=N,e.SteerResult=_,e.JumpDescriptor=O,e.SteeringBehavior=W,e.SeekBehavior=K,e.ArriveBehavior=G,e.AvoidBehavior=Q,e.BlendedSteeringBehavior=ee,e.PursueBehavior=oe,e.LookWhereYouAreGoingBehavior=ne,e.Wander2DBehavior=pe,e.Wander3DBehavior=ye,e.FleeBehavior=le,e.EvadeBehavior=de,e.PathFollowingBehavior=ge,e.PrioritySteeringBehavior=me,e.HideBehavior=ve,e.RandomWaypointBehavior=fe,e.SeparationBehavior=ze,e.AlignBehavior=Ee,e.CohesionBehavior=Se,e.JumpBehavior=Be,e.RandomPathBehavior=we,e.DebugHelper=Te,e.logger=J,Object.defineProperty(e,"__esModule",{value:!0})});