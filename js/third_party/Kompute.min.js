(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Kompute=e.Kompute||{})})(this,function(e){'use strict';var t=Math.cos,o=Math.floor,i=Math.sin,n=Number.EPSILON,a=Math.abs,p=Math.round,l=Math.sqrt,d=Math.max,y=Math.min,c=function(e,t,o){this.x=e||0,this.y=t||0,this.z=o||0};c.prototype.set=function(e,t,o){return this.x=e,this.y=t,this.z=o,this},c.prototype.copy=function(e){return this.set(e.x,e.y,e.z)},c.prototype.clone=function(){return new c().copy(this)},c.prototype.multiplyScalar=function(e){return this.set(this.x*e,this.y*e,this.z*e),this},c.prototype.min=function(e){return this.x=y(this.x,e.x),this.y=y(this.y,e.y),this.z=y(this.z,e.z),this},c.prototype.max=function(e){return this.x=d(this.x,e.x),this.y=d(this.y,e.y),this.z=d(this.z,e.z),this},c.prototype.getLength=function(){return l(this.x*this.x+this.y*this.y+this.z*this.z)},c.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},c.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},c.prototype.normalize=function(){var e=this.getLength();return 0==e?this:(this.x/=e,this.y/=e,this.z/=e,this)},c.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},c.prototype.applyQuaternion=function(e){var t=this.x,o=this.y,i=this.z,n=e.x,r=e.y,a=e.z,p=e.w,s=p*t+r*i-a*o,l=p*o+a*t-n*i,d=p*i+n*o-r*t,y=-n*t-r*o-a*i;return this.x=s*p+y*-n+l*-a-d*-r,this.y=l*p+y*-r+d*-n-s*-a,this.z=d*p+y*-a+s*-r-l*-n,this},c.prototype.cross=function(e){return this.set(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},c.prototype.negate=function(){return this.set(-this.x,-this.y,-this.z)},c.prototype.eql=function(e){return e.x==this.x&&e.y==this.y&&e.z==this.z},c.prototype.toFixed=function(e){return this.set(this.x.toFixed(e),this.y.toFixed(e),this.z.toFixed(e))},c.prototype.getDistanceSq=function(e){var t=this.x-e.x,o=this.y-e.y,i=this.z-e.z;return t*t+o*o+i*i};var u=function(e){this.index=0,this.vectors=[];for(var t=0;t<e;t++)this.vectors.push(new c)};u.prototype.get=function(){var e=this.vectors[this.index++];return this.index==this.vectors.length&&(this.index=0),e};var m=new u(10),h=function(){};h.prototype.clamp=function(e,t,o){return d(t,y(o,e))},h.prototype.uuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),o="x"==e?t:8|3&t;return o.toString(16)})};var g=new u(10),x=function(e,t){this.min=new c,this.max=new c,this.setFromCenterAndSize(e,t)};x.prototype.setFromCenterAndSize=function(e,t){var o=g.get().copy(t).multiplyScalar(.5);return this.min.set(e.x-o.x,e.y-o.y,e.z-o.z),this.max.set(e.x+o.x,e.y+o.y,e.z+o.z),this},x.prototype.makeEmpty=function(){return this.min.set(1/0,1/0,1/0),this.max.set(-Infinity,-Infinity,-Infinity),this},x.prototype.expandByPoint=function(e){return this.min.min(e),this.max.max(e),this},x.prototype.intersectsBox=function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},x.prototype.containsBox=function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},x.prototype.setFromTwoVectors=function(e,t,o){this.makeEmpty(),this.expandByPoint(e),this.expandByPoint(t);var i=g.get().copy(e);return i.x=e.x+o,this.expandByPoint(i),i.x=e.x-o,this.expandByPoint(i),i.x=e.x,i.y=e.y+o,this.expandByPoint(i),i.y=e.y-o,this.expandByPoint(i),i.y=e.y,i.z=e.z+o,this.expandByPoint(i),i.z=e.z-o,this.expandByPoint(i),i.copy(t),i.x=t.x+o,this.expandByPoint(i),i.x=t.x-o,this.expandByPoint(i),i.x=t.x,i.y=t.y+o,this.expandByPoint(i),i.y=t.y-o,this.expandByPoint(i),i.y=t.y,i.z=t.z+o,this.expandByPoint(i),i.z=t.z-o,this.expandByPoint(i),this},x.prototype.isEmpty=function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},x.prototype.getBoundingRadius=function(){var e=g.get().set(0,0,0);return this.isEmpty()||e.copy(this.max).sub(this.min),.5*e.getLength()};var v=function(e,t,o,i){this.limitBox=this.createBox(0,0,0,e,t,o),this.binSize=i,this.bin=new Map,this.reusableResultMap=new Map};v.prototype.createBox=function(e,t,o,i,n,r){var a={};return a.containsBox=function(e){return this.minX<=e.minX&&e.maxX<=this.maxX&&this.minY<=e.minY&&e.maxY<=this.maxY&&this.minZ<=e.minZ&&e.maxZ<=this.maxZ},a.setFromCenterAndSize=function(e,t,o,i,n,r){var a=i/2,p=n/2,s=r/2;this.minX=e-a,this.maxX=e+a,this.minY=t-p,this.maxY=t+p,this.minZ=o-s,this.maxZ=o+s},a.setFromCenterAndSize(e,t,o,i,n,r),a},v.prototype.createObject=function(e,t){var o=this,i={id:e,box:t,binInfo:new Map};return i},v.prototype.insert=function(e){if(this.limitBox.containsBox(e.box)){var t,o,i=this.binSize,n=e.box,r=n.minX,a=n.minY,s=n.minZ,l=n.maxX,d=n.maxY,c=n.maxZ,u=p(r/i)*i;u<=r?(t=u,o=t+i):(o=u,t=u-i),u=p(l/i)*i;var m,h;u<l?(m=u,h=m+i):(h=u,m=u-i),t>m&&(m=t),u=p(a/i)*i;var g,v;u<=a?(g=u,v=g+i):(v=u,g=u-i),u=p(d/i)*i;var f,b;u<d?(f=u,b=f+i):(b=u,f=u-i),g>f&&(f=g),u=p(s/i)*i;var E,D;u<=s?(E=u,D=E+i):(D=u,E=u-i),u=p(c/i)*i;var S,B;u<c?(S=u,B=S+i):(B=u,S=u-i),E>S&&(S=E);for(var P=t;P<=m;P+=i)for(var I=g;I<=f;I+=i)for(var w=E;w<=S;w+=i)this.bin.has(P)||this.bin.set(P,new Map),this.bin.get(P).has(I)||this.bin.get(P).set(I,new Map),this.bin.get(P).get(I).has(w)||this.bin.get(P).get(I).set(w,new Map),this.bin.get(P).get(I).get(w).set(e,!0),e.binInfo.has(P)||e.binInfo.set(P,new Map),e.binInfo.get(P).has(I)||e.binInfo.get(P).set(I,new Map),e.binInfo.get(P).get(I).set(w,!0)}},v.prototype.query=function(e,t,o){var i,n,r=this.binSize,a=p(e/r)*r,s=p(t/r)*r,l=p(o/r)*r;a<=e?(i=a,n=a+r):(n=a,i=a-r);var d,y;s<=t?(d=s,y=s+r):(y=s,d=s-r);var c,u;l<=o?(c=l,u=l+r):(u=l,c=l-r);var m=this.reusableResultMap;m.clear();for(var h=-r;h<=r;h+=r)for(var g=-r;g<=r;g+=r)for(var x=-r;x<=r;x+=r){var v=i+h,f=d+g,b=c+x;if(this.bin.has(v)&&this.bin.get(v).has(f)){var z=this.bin.get(v).get(f).get(b);if(z){var E=!0,D=!1,S=void 0;try{for(var B,P,I=z.keys()[Symbol.iterator]();!(E=(B=I.next()).done);E=!0)P=B.value,m.set(P,!0)}catch(e){D=!0,S=e}finally{try{!E&&I.return&&I.return()}finally{if(D)throw S}}}}}return m},v.prototype.delete=function(e){var t=e.binInfo,o=!0,i=!1,n=void 0;try{for(var r,a=t.keys()[Symbol.iterator]();!(o=(r=a.next()).done);o=!0){var p=r.value,s=!0,l=!1,d=void 0;try{for(var c,u=t.get(p).keys()[Symbol.iterator]();!(s=(c=u.next()).done);s=!0){var m=c.value,y=!0,h=!1,g=void 0;try{for(var v,f,b=t.get(p).get(m).keys()[Symbol.iterator]();!(y=(v=b.next()).done);y=!0)f=v.value,this.bin.has(p)&&this.bin.get(p).has(m)&&this.bin.get(p).get(m).has(f)&&(this.bin.get(p).get(m).get(f).delete(e),0==this.bin.get(p).get(m).get(f).size&&this.bin.get(p).get(m).delete(f),0==this.bin.get(p).get(m).size&&this.bin.get(p).delete(m),0==this.bin.get(p).size&&this.bin.delete(p))}catch(e){h=!0,g=e}finally{try{!y&&b.return&&b.return()}finally{if(h)throw g}}}}catch(e){l=!0,d=e}finally{try{!s&&u.return&&u.return()}finally{if(l)throw d}}}}catch(e){i=!0,n=e}finally{try{!o&&a.return&&a.return()}finally{if(i)throw n}}var E=!0,D=!1,S=void 0;try{for(var B,p,P=t.keys()[Symbol.iterator]();!(E=(B=P.next()).done);E=!0)p=B.value,t.delete(p)}catch(e){D=!0,S=e}finally{try{!E&&P.return&&P.return()}finally{if(D)throw S}}},v.prototype.update=function(e,t,o,i,n,r,a){e.box.setFromCenterAndSize(t,o,i,n,r,a),this.delete(e),this.insert(e)};var f=new u(10),b=new h,z=function(e,t,o,i){this.set(e||0,t||0,o||0,i===void 0?1:i)};z.prototype.set=function(e,t,o,i){return this.x=e,this.y=t,this.z=o,this.w=i,this},z.prototype.copy=function(e){return this.set(e.x,e.y,e.z,e.w),this},z.prototype.clone=function(){return new z().copy(this)},z.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},z.prototype.radialDistanceTo=function(e){return 2*Math.acos(a(b.clamp(this.dot(e),-1,1)))},z.prototype.getLength=function(){return l(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},z.prototype.normalize=function(){var e=this.getLength();return 0==e?this.set(0,0,0,1):this.set(this.x/e,this.y/e,this.z/e,this.w/e)},z.prototype.sphericalLinearInterpolation=function(e,o){var t=Math.atan2;if(0==o)return this;if(1==o)return this.copy(e);var r=this.x,a=this.y,p=this.z,d=this.w,y=d*e.w+r*e.x+a*e.y+p*e.z;if(0>y?(this.set(-e.x,-e.y,-e.z,-e.w),y=-y):this.copy(e),1<=y)return this.set(r,a,p,d);var c=1-y*y;if(c<n){var u=1-o;return this.set(u*r+o*this.x,u*a+o*this.y,u*p+o*this.z,u*d+o*this.w).normalize()}var s=l(c),m=t(s,y),h=i((1-o)*m)/s,g=i(o*m)/s;return this.set(r*h+this.x*g,a*h+this.y*g,p*h+this.z*g,d*h+this.w*g)},z.prototype.rotateTowards=function(e,t){var o=this.radialDistanceTo(e);return 0==o?this:this.sphericalLinearInterpolation(e,y(1,t/o))},z.prototype.setFromVectors=function(e,t){var o=f.get().copy(e).normalize(),i=f.get().copy(t).normalize(),p=o.dot(i)+1;return p<n?a(o.x)>a(i.z)?this.set(-o.y,o.x,0,0):this.set(0,-o.z,o.y,0):this.set(o.y*i.z-o.z*i.y,o.z*i.x-o.x*i.z,o.x*i.y-o.y*i.x,p),this.normalize()};var E=new z,D=new z,S=new u(10),B=function(e,t,o){this.id=e,this.size=o.clone(),this.position=t.clone(),this.world=null,this.box=new x(t,o),this.nearbyObject=null,this.maxSpeed=1/0,this.velocity=new c,this.hasLookTarget=!1,this.lookTarget=new c,this.lookSpeed=.1,this.lookDirection=new c(0,0,-1),this.isHidden=!1,this.limitVelocity=!0};B.prototype.update=function(){if(!this.isHidden){var e=this.velocity.getLength();this.limitVelocity&&e>this.maxSpeed&&this.velocity.copy(this.velocity.normalize().multiplyScalar(this.maxSpeed));var t=S.get().copy(this.velocity).multiplyScalar(1/60);if(this.setPosition(this.position.add(t)),this.hasLookTarget){var o=S.get().copy(this.lookTarget).sub(this.position),i=E.setFromVectors(this.lookDirection,o);D.set(0,0,0,1);var n=S.get().copy(this.lookDirection).applyQuaternion(D.rotateTowards(E,this.lookSpeed));this.setLookDirection(n)}}},B.prototype.setLimitVelocity=function(e){this.limitVelocity=e},B.prototype.setPositionAndSize=function(e,t){return!this.isHidden&&(this.setPosition(e,!0),this.setSize(t),!0)},B.prototype.setSize=function(e,t){return!this.isHidden&&(this.size.copy(e),this.box.setFromCenterAndSize(this.position,e),this.world&&!t&&this.world.updateEntity(this,this.position,this.size),!0)},B.prototype.setPosition=function(e,t){return!this.isHidden&&(this.position.copy(e),this.box.setFromCenterAndSize(e,this.size),this.world&&!t&&this.world.updateEntity(this,this.position,this.size),!0)},B.prototype.setLookDirection=function(e){this.lookDirection.copy(S.get().copy(e).normalize()),this.world&&this.world.onLookDirectionUpdated(this)},B.prototype.executeForEachCloseEntity=function(e){if(this.world){var t=this.world.getNearbyObjects(this.position),o=!0,i=!1,n=void 0;try{for(var r,a,p=t[Symbol.iterator]();!(o=(r=p.next()).done);o=!0)if(a=r.value,a.id!=this.id&&e(this.world.getEntityByID(a.id)))return}catch(e){i=!0,n=e}finally{try{!o&&p.return&&p.return()}finally{if(i)throw n}}}},B.prototype.setLookTarget=function(e){this.lookTarget.copy(e),this.hasLookTarget=!0},B.prototype.unsetLookTarget=function(){this.hasLookTarget=!1},B.prototype.isNearTo=function(e){var t=!1;return this.executeForEachCloseEntity(function(o){if(o===e)return t=!0,!0}),t};var P=new c(1,1,1),I=function(e,t){var o=e.clone(),i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),o="x"==e?t:8|3&t;return o.toString(16)});B.call(this,"vertex#"+i,o,P),this.position=o,this.graph=t};I.prototype=Object.create(B.prototype),Object.defineProperty(I.prototype,"constructor",{value:I,enumerable:!1,writable:!0});var w=function(e,t,o,i){this.width=e,this.height=t,this.depth=o,this.nearby=new v(e,t,o,i),this.entititesByID={},this.gravity=0};w.prototype.setGravity=function(e){this.gravity=e},w.prototype.getEntityByID=function(e){return this.entititesByID[e]||null},w.prototype.insertGraph=function(e){if(!e.world){var t=this;e.forEachVertex(function(o,i,n){var r=new I(new c(o,i,n),e);t.insertEntity(r),e.vertexIDs.push(r.id)}),e.world=this}},w.prototype.removeGraph=function(e){if(e.world){for(var t=0;t<e.vertexIDs.length;t++){var o=e.vertexIDs[t],n=this.getEntityByID(o);this.removeEntity(n)}e.world=null,e.vertexIDs=[]}},w.prototype.hideEntity=function(e){return this.entititesByID[e.id]&&!e.isHidden&&(this.nearby.delete(e.nearbyObject),e.isHidden=!0,this.onEntityHidden&&this.onEntityHidden(e),!0)},w.prototype.showEntity=function(e){return!!(this.entititesByID[e.id]&&e.isHidden)&&(this.nearby.insert(e.nearbyObject),e.isHidden=!1,this.onEntityShown&&this.onEntityShown(e),!0)},w.prototype.insertEntity=function(e){this.entititesByID[e.id]=e;var t=e.position,o=e.size,i=this.nearby.createBox(t.x,t.y,t.z,o.x,o.y,o.z),n=this.nearby.createObject(e.id,i);this.nearby.insert(n),e.world=this,e.nearbyObject=n,e.lastWorldPosition=t.clone(),e.lastWorldSize=o.clone(),this.onEntityInserted&&this.onEntityInserted(e)},w.prototype.updateEntity=function(e,t,o){e.isHidden||e.lastWorldPosition.eql(t)&&e.lastWorldSize.eql(o)||(this.nearby.update(e.nearbyObject,t.x,t.y,t.z,o.x,o.y,o.z),this.onEntityUpdated&&this.onEntityUpdated(e),e.lastWorldPosition.copy(t),e.lastWorldSize.copy(o))},w.prototype.onLookDirectionUpdated=function(e){this.onEntityLookDirectionUpdated&&this.onEntityLookDirectionUpdated(e)},w.prototype.removeEntity=function(e){delete this.entititesByID[e.id],this.nearby.delete(e.nearbyObject),this.onEntityRemoved&&this.onEntityRemoved(e),delete e.lastWorldPosition,delete e.lastWorldSize},w.prototype.getNearbyObjects=function(e){return this.nearby.query(e.x,e.y,e.z).keys()},w.prototype.forEachEntity=function(e){for(var t in this.entititesByID){var o=this.entititesByID[t];e(o)}};var C=function(e){if(e=e||{},this.index=0,this.length=0,this.jumpDescriptorLength=0,this.loop=!!e.loop,this.rewind=!!e.rewind,this.isRewinding=!1,this.isFinished=!1,this.waypoints=[],this.jumpDescriptors=[],e.fixedLength)for(var t=0;t<e.fixedLength;t++)this.waypoints.push(new c),this.jumpDescriptors.push(null);this.options=JSON.parse(JSON.stringify(e))};C.prototype.clone=function(){var e=new C(this.options);if(!this.options.fixedLength){for(var t=0;t<this.waypoints.length;t++)e.addWaypoint(this.waypoints[t]);for(var t=0;t<this.jumpDescriptors.length;t++)e.addJumpDescriptor(this.jumpDescriptors[t])}else{for(var t=0;t<this.length;t++)e.insertWaypoint(this.waypoints[t]);for(var t=0;t<this.jumpDescriptorLength;t++)e.insertJumpDescriptor(this.jumpDescriptors[t])}return e},C.prototype.restart=function(){this.isRewinding=!1,this.isFinished=!1,this.index=0},C.prototype.insertJumpDescriptor=function(e){this.jumpDescriptors[this.jumpDescriptorLength++]=e},C.prototype.addJumpDescriptor=function(e){var t=e.takeoffPosition,o=e.landingPosition,i=this.getWaypointIndex(t);if(null==i)return!1;var n=this.getWaypointIndex(o);return null!=n&&!(i>=n)&&(this.jumpDescriptors.push(e),this.jumpDescriptorLength++,!0)},C.prototype.getWaypointIndex=function(e){var t=this.length,o=this.waypoints.findIndex(function(o,i){return i<t&&o.eql(e)});return-1==o?null:o},C.prototype.insertWaypoint=function(e){this.waypoints[this.length++].copy(e)},C.prototype.addWaypoint=function(e){this.waypoints.push(e.clone()),this.length++},C.prototype.getCurrentWaypoint=function(){return!this.isFinished&&(this.waypoints[this.index]||!1)},C.prototype.onFinished=function(){this.finishCallback&&this.finishCallback()},C.prototype.next=function(){if(!this.isFinished){var e=this.length;this.isRewinding?(this.index--,-1==this.index&&(this.loop?(this.index=1,this.isRewinding=!1):(this.isFinished=!0,this.onFinished()))):(this.index++,this.index==e&&(this.rewind?(this.index=e-2,this.isRewinding=!0):this.loop?this.index=0:(this.isFinished=!0,this.onFinished())))}},C.prototype.getRandomWaypoint=function(){return this.waypoints[o(Math.random()*this.length)]||null};var T=function(e,t){this.fromVertex=e.clone(),this.toVertex=t.clone(),this.cost=e.clone().sub(t).getLength(),this.jumpDescriptor=null};T.prototype.clone=function(){return new T(this.fromVertex,this.toVertex)};var k=function(){this.world=null,this.connections={},this.totalVertexCount=0,this.vertexIDs=[]};k.prototype.clone=function(){var e=new k;return this.forEachVertex(function(t,o,i){e.addVertex(new c(t,o,i))}),this.forEachEdge(function(t){e.addEdge(t.fromVertex,t.toVertex)}),this.forEachEdge(function(t){t.jumpDescriptor&&e.addJumpDescriptor(t.jumpDescriptor)}),e},k.prototype.findClosestVertexToPoint=function(e){var t=this.world;if(!t)return null;var o=1/0,i=null,n=this.world.getNearbyObjects(e),r=!0,a=!1,p=void 0;try{for(var s,l=n[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var d=s.value,y=t.getEntityByID(d.id);if(y instanceof I&&y.graph===this){var c=e.getDistanceSq(y.position);c<o&&(i=y,o=c)}}}catch(e){a=!0,p=e}finally{try{!r&&l.return&&l.return()}finally{if(a)throw p}}return i?i.position:null},k.prototype.addVertex=function(e){if(this.hasVertex(e))return!1;var t=e.x,o=e.y,i=e.z;return this.connections[t]||(this.connections[t]={}),this.connections[t][o]||(this.connections[t][o]={}),this.connections[t][o][i]||(this.connections[t][o][i]=[]),this.totalVertexCount++,!0},k.prototype.removeVertex=function(e){if(!this.hasVertex(e))return!1;var t=e.x,o=e.y,n=e.z;for(var t in delete this.connections[t][o][n],0==Object.keys(this.connections[t][o]).length&&delete this.connections[t][o],0==Object.keys(this.connections[t]).length&&delete this.connections[t],this.connections)for(var o in this.connections[t])for(var n in this.connections[t][o]){for(var r=this.connections[t][o][n],a=-1,p=0;p<r.length;p++){var s=r[p],l=s.toVertex;if(l.x==e.x&&l.y==e.y&&l.z==e.z){a=p;break}}-1!=a&&(r.splice(a,1),this.connections[t][o][n]=r)}return this.totalVertexCount--,!0},k.prototype.hasVertex=function(e){var t=e.x,o=e.y,i=e.z;return!!(this.connections[t]&&this.connections[t][o]&&this.connections[t][o][i])},k.prototype.addEdge=function(e,t){if(!this.hasVertex(e)||!this.hasVertex(t))return!1;for(var o,n=this.connections[e.x][e.y][e.z],r=0;r<n.length;r++)if(o=n[r].toVertex,o.x==t.x&&o.y==t.y&&o.z==t.z)return!1;var a=new T(e,t);return n.push(a),!0},k.prototype.addJumpDescriptor=function(e){var t=e.takeoffPosition,o=e.landingPosition;if(!this.hasVertex(t)||!this.hasVertex(o))return!1;for(var n,r=this.connections[t.x][t.y][t.z],a=null,p=0;p<r.length;p++)if(n=r[p].toVertex,n.x==o.x&&n.y==o.y&&n.z==o.z){a=r[p];break}return a?a.jumpDescriptor=e:(a=new T(t,o),a.jumpDescriptor=e,r.push(a)),!0},k.prototype.removeEdge=function(e,t){if(!this.hasVertex(e)||!this.hasVertex(t))return!1;for(var o=this.connections[e.x][e.y][e.z],n=-1,r=0;r<o.length;r++){var a=o[r],p=a.toVertex;if(p.x==t.x&&p.y==t.y&&p.z==t.z){n=r;break}}return-1!=n&&(o.splice(n,1),this.connections[e.x][e.y][e.z]=o,!0)},k.prototype.forEachNeighbor=function(e,t){if(this.hasVertex(e))for(var o,n=this.connections[e.x][e.y][e.z],r=0;r<n.length;r++)o=n[r],t(o.toVertex,o.cost,o.jumpDescriptor)},k.prototype.forEachVertex=function(e){for(var t in this.connections)for(var o in this.connections[t])for(var i in this.connections[t][o])e(parseFloat(t),parseFloat(o),parseFloat(i))},k.prototype.forEachEdge=function(e){for(var t in this.connections)for(var o in this.connections[t])for(var n in this.connections[t][o])for(var r=this.connections[t][o][n],a=0;a<r.length;a++)e(r[a])};var R=function(e){this.data=[];for(var t=0;t<e;t++)this.data.push(null);this.length=0,this.HEAP_CHECK_RESULT_OK=0,this.HEAP_CHECK_RESULT_LEFT=1,this.HEAP_CHECK_RESULT_RIGHT=2};R.prototype.reset=function(){for(var e=0;e<this.data.length;e++)this.data[e]=null;this.length=0},R.prototype.peek=function(){return this.data[0]},R.prototype.getParentIndex=function(e){return o(e/2)},R.prototype.getLeftChildIndex=function(e){return this.getRightChildIndex(e)-1},R.prototype.getRightChildIndex=function(e){return 2*(e+1)},R.prototype.insert=function(e){if(this.data.length==this.length)return!1;var t=this.length,o=this.getParentIndex(this.length);this.data[t]=e;for(var i=this.data[o];i&&e.priority<i.priority;)this.data[o]=e,this.data[t]=i,t=o,o=this.getParentIndex(t),i=this.data[o];return this.length++,!0},R.prototype.remove=function(e){var t=this.data.indexOf(e);if(-1==t)return!1;var o=this.length-1;return this.swap(t,o),this.data[o]=null,this.length--,this.reconstruct(t),!0},R.prototype.heapCheck=function(e){var t=this.data[e];if(!t)return this.HEAP_CHECK_RESULT_OK;var o=this.getLeftChildIndex(e),i=this.getRightChildIndex(e),n=this.data[o],r=this.data[i];if(!n&&!r)return this.HEAP_CHECK_RESULT_OK;return r?t.priority<=n.priority&&t.priority<=r.priority?this.HEAP_CHECK_RESULT_OK:n.priority<=t.priority&&n.priority<=r.priority?this.HEAP_CHECK_RESULT_LEFT:this.HEAP_CHECK_RESULT_RIGHT:t.priority<=n.priority?this.HEAP_CHECK_RESULT_OK:this.HEAP_CHECK_RESULT_LEFT},R.prototype.swap=function(e,t){var o=this.data[e],i=this.data[t];this.data[e]=i,this.data[t]=o},R.prototype.pop=function(){if(0==this.length)return!1;var e=this.data[0],t=this.length-1;return this.data[0]=this.data[t],this.data[t]=null,this.length--,this.reconstruct(0),e},R.prototype.reconstruct=function(e){for(var t=this.heapCheck(e);t!=this.HEAP_CHECK_RESULT_OK;){if(t==this.HEAP_CHECK_RESULT_LEFT){var o=this.getLeftChildIndex(e);this.swap(e,o),e=o}else{var i=this.getRightChildIndex(e);this.swap(e,i),e=i}t=this.heapCheck(e)}},R.prototype.hasNode=function(e){return 0<=this.data.indexOf(e)};var A=new u(10),L=new h,M=function(e){var t=new C({fixedLength:e.totalVertexCount}),o={};e.forEachVertex(function(e,t,i){o[e]||(o[e]={}),o[e][t]||(o[e][t]={}),o[e][t][i]||(o[e][t][i]={priority:0,parent:null,x:parseFloat(e),y:parseFloat(t),z:parseFloat(i),closedTag:null,parentTag:null,priorityTag:null,jumpDescriptor:null})}),this.heapNodes=o,this.path=t,this.graph=e,this.heap=new R(e.totalVertexCount),this._internalID=L.uuidv4(),this.searchID=0};M.prototype.getHeapNode=function(e,t,o,i){var n=i?i[e]:this.heapNodes[e];if(n){var r=n[t];return r?r[o]||null:null}return null},M.prototype.isNodeBelongToVector=function(e,t){return e===this.getHeapNode(t.x,t.y,t.z)},M.prototype.generatePath=function(e){var t=this.path;t.length=0;for(var o=e,i=this.getHeapNode(o.x,o.y,o.z);i;){t.insertWaypoint(o);var n=i.jumpDescriptor;n&&t.insertJumpDescriptor(n);var r=i.parentTag;i=i.parent,i&&r!=this.searchID&&(i=null),i&&(o=A.get().set(i.x,i.y,i.z))}return t.isRewinding=!0,t.index=t.length-1,t.isFinished=!1,this.onPathConstructed&&this.onPathConstructed(),t},M.prototype.markNodeAsClosed=function(e,t){e.closedTag=t},M.prototype.isNodeClosed=function(e,t){return e.closedTag===t},M.prototype.findShortestPath=function(e,t){var o=this.heapNodes;this.searchID++;var i=this.searchID,n=this.heap;n.reset();var r=this.graph;if(!r.hasVertex(e)||!r.hasVertex(t))return!1;var a=this.getHeapNode,p=this.isNodeClosed,s=this.markNodeAsClosed,l=this.getHeapNode(e.x,e.y,e.z),d=A.get();for(n.insert(l);l;){if(this.isNodeBelongToVector(l,t))return this.generatePath(t);s(l,i),d.set(l.x,l.y,l.z),r.forEachNeighbor(d,function(e,r,d){var y=a(e.x,e.y,e.z,o),c=e.getDistanceSq(t);if(p(y,i)||(y.priority=r+c,y.priorityTag=i,y.parent=l,y.parentTag=i,y.jumpDescriptor=d,s(y,i),n.insert(y)),n.hasNode(y)){var u=c+r;u<y.priority&&y.priorityTag==i&&(y.priority=u,y.parent=l,y.parentTag=i,y.jumpDescriptor=d,n.remove(y),n.insert(y))}}),l=n.pop()}return!1};var j=function(){this.logMethod=console.log,this.isEnabled=!1,this.lastMessageMap={}};j.prototype.enable=function(){this.isEnabled=!0},j.prototype.disable=function(){this.isEnabled=!1},j.prototype.log=function(e,t,o){this.isEnabled&&this.lastMessageMap[o]!=t&&(this.logMethod("["+e+"]: "+t+" ("+o+")"),this.lastMessageMap[o]=t)};var J=new j,H="Steerable",V=1/60,F=new u(10),N=function(e,t,o){B.call(this,e,t,o),this.hasTargetPosition=!1,this.hasTargetEntity=!1,this.hasHideTargetEntity=!1,this.targetPosition=new c,this.targetEntity=null,this.hideTargetEntity=null,this.linearAcceleration=new c,this.maxAcceleration=1/0,this.isJumpInitiated=!1,this.isJumpReady=!1,this.isJumpTakenOff=!1,this.jumpSpeed=1/0,this.jumpTime=0};N.prototype=Object.create(B.prototype),N.prototype.update=function(){if(this.isHidden)return void J.log(H,"Steerable is hidden.",this.id);if(!this.world)return void J.log(H,"Not inserted to a world.",this.id);if(!this.behavior)return void J.log(H,"Has no behavior.",this.id);var e=this.behavior.compute(this);this.linearAcceleration.copy(e.linear);var t=this.linearAcceleration.getLength();t>this.maxAcceleration&&this.linearAcceleration.copy(this.linearAcceleration.normalize().multiplyScalar(this.maxAcceleration)),this.isJumpTakenOff&&(this.linearAcceleration.y+=this.world.gravity,this.jumpTime+=V,this.jumpTime>=this.jumpDescriptor.getEquationResult(this).time&&(J.log(H,"Jump completed.",this.id),this.onJumpCompleted()));var o=F.get().copy(this.linearAcceleration).multiplyScalar(V);if(this.velocity.add(o),B.prototype.update.call(this),this.isJumpInitiated&&!this.isJumpTakenOff&&!this.isJumpReady){var i=F.get().copy(this.position).sub(this.jumpDescriptor.takeoffPosition).getLength();i<this.jumpDescriptor.takeoffPositionSatisfactionRadius&&(J.log(H,"Jump ready.",this.id),this.onJumpReady())}},N.prototype.setJumpBehavior=function(e){this.isJumpInitiated||(this.jumpBehavior=e)},N.prototype.setBehavior=function(e){this.isJumpInitiated||(this.behavior=e)},N.prototype.unsetTargetPosition=function(){this.isJumpInitiated||(this.hasTargetPosition=!1)},N.prototype.setTargetPosition=function(e){this.isJumpInitiated||(this.targetPosition.copy(e),this.hasTargetPosition=!0)},N.prototype.setTargetEntity=function(e){this.isJumpInitiated||(this.targetEntity=e,this.hasTargetEntity=!0)},N.prototype.unsetTargetEntity=function(){this.isJumpInitiated||(this.hasTargetEntity=!1,this.targetEntity=null)},N.prototype.setHideTargetEntity=function(e){this.isJumpInitiated||(this.hideTargetEntity=e,this.hasHideTargetEntity=!0)},N.prototype.unsetHideTargetEntity=function(){this.isJumpInitiated||(this.hasHideTargetEntity=!1,this.hideTargetEntity=null)},N.prototype.jump=function(e,t){var o=t.solveQuadraticEquation(this);return o?(this.isJumpInitiated=!1,this.isJumpReady=!1,this.isJumpTakenOff=!1,this.unsetTargetEntity(),this.unsetHideTargetEntity(),this.setTargetPosition(t.takeoffPosition),this.setBehavior(e),this.jumpDescriptor=t,this.isJumpInitiated=!0,this.jumpTime=0,J.log(H,"Jump initiated.",this.id),!0):(J.log(H,"Equation cannot be solved.",this.id),!1)},N.prototype.cancelJump=function(){return!!(this.isJumpInitiated||this.isJumpReady||this.isJumpTakenOff)&&(this.onJumpCompleted(!0),!0)},N.prototype.onJumpReady=function(){this.isJumpReady=!0,this.isJumpInitiated=!1,this.setBehavior(this.jumpBehavior),this.isJumpInitiated=!0,this.jumpBehavior||J.log(H,"No jump behavior set.",this.id)},N.prototype.onJumpTakeOff=function(){this.isJumpTakenOff=!0;var e=this.jumpDescriptor,t=e.getEquationResult(this);this.setLimitVelocity(!1),this.velocity.set(t.vx,this.jumpSpeed,t.vz)},N.prototype.onJumpCompleted=function(e){this.jumpTime=0,this.isJumpInitiated=!1,this.isJumpReady=!1,this.isJumpTakenOff=!1,e||(this.position.y=this.jumpDescriptor.landingPosition.y),this.velocity.set(0,0,0),this.linearAcceleration.set(0,0,0),this.setLimitVelocity(!0),!e&&this.jumpCompletionCallback&&this.jumpCompletionCallback(this)},N.prototype.setJumpCompletionListener=function(e){this.jumpCompletionCallback=e},N.prototype.removeJumpCompletionListener=function(){this.jumpCompletionCallback=null},Object.defineProperty(N.prototype,"constructor",{value:N,enumerable:!1,writable:!0});var _=function(){this.linear=new c},O=new h,W=function(e){this.takeoffPosition=e.takeoffPosition.clone(),this.landingPosition=e.landingPosition.clone(),this.takeoffPositionSatisfactionRadius=e.takeoffPositionSatisfactionRadius,this.delta=this.landingPosition.clone().sub(this.takeoffPosition),this.checkTimeResult={vx:0,vz:0,isAchievable:!1},this.cache={},this._internalID=O.uuidv4()};W.prototype.getEquationResult=function(e){var t=e.jumpSpeed,o=e.maxSpeed,i=e.world.gravity,n=this.cache;return n[t]&&n[t][o]&&n[t][o][i]?n[t][o][i]:null},W.prototype.setCache=function(e,t){var o=e.jumpSpeed,i=e.maxSpeed,n=e.world.gravity,r=this.cache;r[o]||(r[o]={}),r[o][i]||(r[o][i]={}),r[o][i][n]||(r[o][i]={}),r[o][i][n]=t},W.prototype.solveQuadraticEquation=function(e){var t=this.getEquationResult(e);if(t)return t;t={time:0,vx:0,vz:0,isAchievable:!1},this.setCache(e,t),t.isAchievable=!1;var o=e.jumpSpeed,i=e.maxSpeed,n=e.world,r=n.gravity,a=2*r*this.delta.y+o*o,p=l(a),s=(-o+p)/r,d=this.checkTime(s,i);return t.time=s,t.vx=d.vx,t.vz=d.vz,t.isAchievable=d.isAchievable,d.isAchievable||(s=(-o-p)/r,d=this.checkTime(s,i),t.time=s,t.vx=d.vx,t.vz=d.vz,t.isAchievable=d.isAchievable),!!t.isAchievable&&t},W.prototype.checkTime=function(e,t){this.checkTimeResult.isAchievable=!1;var o=this.delta.x/e,i=this.delta.z/e;return o*o+i*i<=t*t&&(this.checkTimeResult.isAchievable=!0,this.checkTimeResult.vx=o,this.checkTimeResult.vz=i),this.checkTimeResult};var K=function(){this.result=new _};K.prototype.compute=function(){return this.result.linear.set(0,0,0),this.result};var q=function(){K.call(this)};q.prototype=Object.create(K.prototype),q.prototype.compute=function(e){return(this.result.linear.set(0,0,0),!e.hasTargetPosition)?(J.log("SeekBehavior","No target position.",e.id),this.result):(this.result.linear.copy(e.targetPosition).sub(e.position).normalize().multiplyScalar(e.maxAcceleration),J.log("SeekBehavior","Speeding up.",e.id),this.result)},Object.defineProperty(q.prototype,"constructor",{value:q,enumerable:!1,writable:!0});var U=new u(10),G="ArriveBehavior",Y=function(e){K.call(this),this.satisfactionRadius=e.satisfactionRadius,this.slowDownRadius=e.slowDownRadius};Y.prototype=Object.create(K.prototype),Y.prototype.compute=function(e){if(this.result.linear.set(0,0,0),!e.hasTargetPosition)return J.log(G,"Steerable has no target position.",e.id),this.result;var t=U.get().copy(e.targetPosition).sub(e.position),o=t.getLength(),i=U.get().set(0,0,0);return o<=this.satisfactionRadius?(J.log(G,"Arrived.",e.id),this.result):(i.copy(t).normalize().multiplyScalar(e.maxSpeed),o<=this.slowDownRadius?(J.log(G,"Slowing down.",e.id),i.multiplyScalar(o/this.slowDownRadius)):J.log(G,"Speeding up.",e.id),this.result.linear.copy(i).sub(e.velocity),this.result)},Object.defineProperty(Y.prototype,"constructor",{value:Y,enumerable:!1,writable:!0});var X=new x(new c(),new c()),Z=new u(10),Q="AvoidBehavior",$=function(e){K.call(this),this.maxSeeAhead=e.maxSeeAhead,this.maxAvoidForce=e.maxAvoidForce};$.prototype=Object.create(K.prototype),$.prototype.findMostThreateningObstacle=function(e){var t=null,o=this.maxSeeAhead,i=e.position,n=Z.get().copy(e.velocity);n.normalize().multiplyScalar(o);var r=Z.get().copy(n).add(i);return X.setFromTwoVectors(i,r,.001),X.expandByPoint(e.box.min),X.expandByPoint(e.box.max),e.executeForEachCloseEntity(function(e){if(X.intersectsBox(e.box))if(!t)t=e;else{var o=Z.get().copy(i).sub(e.position).getLength(),n=Z.get().copy(i).sub(t.position).getLength();o<=n&&(t=e)}}),t},$.prototype.compute=function(e){this.result.linear.set(0,0,0);var t=this.findMostThreateningObstacle(e);return t?(J.log(Q,"Threatening entity found.",e.id),this.result.linear.copy(e.velocity).normalize().multiplyScalar(e.velocity.getLength()/e.maxSpeed).add(e.position).sub(t.position).normalize().multiplyScalar(this.maxAvoidForce),this.result):(J.log(Q,"No threatening entity found.",e.id),this.result)},Object.defineProperty($.prototype,"constructor",{value:$,enumerable:!1,writable:!0});var ee=new u(10),te=function(e){K.call(this),this.definitions=e};te.prototype=Object.create(K.prototype),te.prototype.compute=function(e){this.result.linear.set(0,0,0);for(var t=0;t<this.definitions.length;t++){var o=this.definitions[t],n=o.behavior,r=o.weight,a=n.compute(e);a&&this.result.linear.add(ee.get().copy(a.linear).multiplyScalar(r))}return this.result},Object.defineProperty(te.prototype,"constructor",{value:te,enumerable:!1,writable:!0});var oe=new u(10),ie=function(e){q.call(this),this.maxPredictionTime=e.maxPredictionTime};ie.prototype=Object.create(q.prototype),ie.prototype.compute=function(e){if(this.result.linear.set(0,0,0),!e.hasTargetEntity)return J.log("PursueBehavior","Entity has no target entity.",e.id),this.result;var t=e.targetEntity,o=t.position,i=e.velocity.getLength(),n=this.maxPredictionTime;if(0<i){var r=oe.get().copy(o).sub(e.position).getLength(),a=r/i;a<this.maxPredictionTime&&(n=a)}var p=oe.get().copy(t.velocity).multiplyScalar(n).add(o);return e.setTargetPosition(p),J.log("PursueBehavior","Seeking.",e.id),q.prototype.compute.call(this,e)},Object.defineProperty(ie.prototype,"constructor",{value:q,enumerable:!1,writable:!0});var ne=new u(10),re=function(){K.call(this)};re.prototype=Object.create(K.prototype),re.prototype.compute=function(e){this.result.linear.set(0,0,0);var t=ne.get().copy(e.position).add(e.velocity);return e.setLookTarget(t),this.result},Object.defineProperty(re.prototype,"constructor",{value:re,enumerable:!1,writable:!0});var ae=new u(10),pe=new z,se=function(e){K.call(this),this.normal=e.normal.clone().normalize(),this.wanderCircleDistance=e.wanderCircleDistance,this.wanderCircleRadius=e.wanderCircleRadius,this.angleChange=e.angleChange,this.angle=0};se.prototype=Object.create(K.prototype),se.prototype.compute=function(e){var t=this.getCircleCenter(e),o=this.getDisplacementForce();return this.result.linear.copy(t).add(o),this.angle+=Math.random()*this.angleChange-.5*this.angleChange,this.result},se.prototype.getCircleCenter=function(e){var t=this.wanderCircleDistance;return ae.get().copy(e.velocity).normalize().multiplyScalar(t)},se.prototype.getDisplacementForce=function(){var e=ae.get().set(0,0,0);e.x=t(this.angle),e.z=i(this.angle),e.normalize().multiplyScalar(this.wanderCircleRadius);var o=pe.setFromVectors(ae.get().set(0,1,0),this.normal);return e.applyQuaternion(o),e},Object.defineProperty(se.prototype,"constructor",{value:se,enumerable:!1,writable:!0});var le=new u(10),de=function(e){se.call(this,{wanderCircleDistance:e.wanderSphereDistance,angleChange:e.angleChange,normal:new c}),this.angle2=0,this.wanderSphereRadius=e.wanderSphereRadius};de.prototype=Object.create(se.prototype),de.prototype.compute=function(e){var t=this.getCircleCenter(e),o=this.getDisplacementForce();return this.result.linear.copy(t).add(o),this.angle+=Math.random()*this.angleChange-.5*this.angleChange,this.angle2+=Math.random()*this.angleChange-.5*this.angleChange,this.result},de.prototype.getDisplacementForce=function(){var e=le.get().set(0,0,0);return e.x=i(this.angle)*t(this.angle2),e.y=i(this.angle)*i(this.angle2),e.z=t(this.angle),e.normalize().multiplyScalar(this.wanderSphereRadius)},Object.defineProperty(de.prototype,"constructor",{value:de,enumerable:!1,writable:!0});var ye=function(){q.call(this)};ye.prototype=Object.create(q.prototype),ye.prototype.compute=function(e){return q.prototype.compute.call(this,e),this.result.linear.negate(),this.result},Object.defineProperty(ye.prototype,"constructor",{value:ye,enumerable:!1,writable:!0});var ce=function(e){ie.call(this,e)};ce.prototype=Object.create(ie.prototype),ce.prototype.compute=function(e){return ie.prototype.compute.call(this,e),this.result.linear.negate(),this.result},Object.defineProperty(ce.prototype,"constructor",{value:ce,enumerable:!1,writable:!0});var ue=new u(10),me="PathFollowingBehavior",he=function(e){q.call(this),this.path=e.path,this.satisfactionRadius=e.satisfactionRadius||0,this.onJumpCompletionCallback=this.onJumpCompleted.bind(this)};he.prototype=Object.create(q.prototype),he.prototype.getNext=function(){var e=this.path;return e.next(),e.getCurrentWaypoint()},he.prototype.getCurrentWaypoint=function(){return this.path.getCurrentWaypoint()},he.prototype.compute=function(e){this.result.linear.set(0,0,0);var t=this.path,o=this.getCurrentWaypoint();if(!o)return J.log(me,"No waypoint.",e.id),this.result;var i=this.isJumpNeeded(e);if(i)return this.beforeJumpBehavior=e.behavior,e.jumpDescriptor=i,e.onJumpReady(),e.setJumpCompletionListener(this.onJumpCompletionCallback),J.log(me,"Jump initiated.",e.id),this.result;var n=ue.get().copy(o).sub(e.position).getLength();return n<=this.satisfactionRadius&&(o=this.getNext(),J.log(me,"Next waypoint.",e.id),!o)?(J.log(me,"Path completed.",e.id),this.result):(e.setTargetPosition(o),q.prototype.compute.call(this,e))},he.prototype.isJumpNeeded=function(e){for(var t=this.path,o=t.jumpDescriptors,n=0;n<t.jumpDescriptorLength;n++){var r=o[n],a=ue.get().copy(e.position).sub(r.takeoffPosition).getLength();if(a<r.takeoffPositionSatisfactionRadius){var p=r.solveQuadraticEquation(e);if(p)return r}}return!1},he.prototype.onJumpCompleted=function(e){for(var t=e.jumpDescriptor,o=t.landingPosition,i=this.path,n=i.getWaypointIndex(o);i.index!=n&&!i.isFinished;)i.next();e.setBehavior(this.beforeJumpBehavior)},Object.defineProperty(he.prototype,"constructor",{value:he,enumerable:!1,writable:!0});var ge=function(e){K.call(this),this.threshold=e.threshold,this.list=e.list};ge.prototype=Object.create(K.prototype),ge.prototype.compute=function(e){this.result.linear.set(0,0,0);for(var t,o=0;o<this.list.length;o++)if(t=this.list[o].compute(e),t.linear.getLength()>this.threshold)return this.result.linear.copy(t.linear),J.log("PrioritySteeringBehavior","Computed.",e.id),this.result;return J.log("PrioritySteeringBehavior","Not computed.",e.id),this.result},Object.defineProperty(ge.prototype,"constructor",{value:ge,enumerable:!1,writable:!0});var xe=new u(10),ve="HideBehavior",fe=function(e){Y.call(this,{satisfactionRadius:e.arriveSatisfactionRadius,slowDownRadius:e.arriveSlowDownRadius}),this.hideDistance=e.hideDistance,this.threatDistance=e.threatDistance,this.hidingSpotFound=!1,this.bestHidingSpot=new c};fe.prototype=Object.create(Y.prototype),fe.prototype.compute=function(e){return(this.result.linear.set(0,0,0),!e.hideTargetEntity)?(J.log(ve,"No hide target entity set.",e.id),this.result):xe.get().copy(e.position).sub(e.hideTargetEntity.position).getLength()>this.threatDistance?(J.log(ve,"Target entity is out of threat distance.",e.id),this.result):(this.findHidingSpot(e),!this.hidingSpotFound)?(J.log(ve,"No hiding spot found.",e.id),this.result):(J.log(ve,"Hiding.",e.id),e.setTargetPosition(this.bestHidingSpot),Y.prototype.compute.call(this,e))},fe.prototype.findHidingSpot=function(e){this.hidingSpotFound=!1;var t=null,o=this;e.executeForEachCloseEntity(function(i){if(!(i instanceof N)){var n=o.getHidingPosition(i,e),r=xe.get().copy(n).sub(e.position).getLength();(null==t||r<t)&&(t=r,o.hidingSpotFound=!0,o.bestHidingSpot.copy(n))}})},fe.prototype.getHidingPosition=function(e,t){var o=t.hideTargetEntity.position,i=e.box.getBoundingRadius(),n=i+this.hideDistance,r=e.position;return xe.get().copy(r).sub(o).normalize().multiplyScalar(n).add(r)},Object.defineProperty(fe.prototype,"constructor",{value:fe,enumerable:!1,writable:!0});var be=function(e){he.call(this,e)};be.prototype=Object.create(he.prototype),be.prototype.getNext=function(){var e=this.path;return this.currentWayPoint=e.getRandomWaypoint(),this.currentWayPoint},be.prototype.getCurrentWaypoint=function(){return this.currentWayPoint?this.currentWayPoint:this.getNext()},Object.defineProperty(be.prototype,"constructor",{value:be,enumerable:!1,writable:!0});var ze=new u(10),Ee=function(e){K.call(this),this.strength=e.strength};Ee.prototype=Object.create(K.prototype),Ee.prototype.compute=function(e){var t=this.result.linear;t.set(0,0,0);var o=this.strength;return e.executeForEachCloseEntity(function(i){if(i instanceof N){var n=ze.get().copy(e.position).sub(i.position),r=n.getLength();0==r||(n.normalize().multiplyScalar(o/r),t.add(n))}}),this.result},Object.defineProperty(Ee.prototype,"constructor",{value:Ee,enumerable:!1,writable:!0});var De=function(){K.call(this)};De.prototype=Object.create(K.prototype),De.prototype.compute=function(e){var t=this.result.linear;t.set(0,0,0);var o=0;return e.executeForEachCloseEntity(function(e){e instanceof N&&(t.add(e.velocity),o++)}),0<o?(t.multiplyScalar(1/o),t.sub(e.velocity),J.log("AlignBehavior","Close entities exist.",e.id)):J.log("AlignBehavior","No close entities exist.",e.id),this.result},Object.defineProperty(De.prototype,"constructor",{value:De,enumerable:!1,writable:!0});var Se=function(){q.call(this)};Se.prototype=Object.create(q.prototype),Se.prototype.compute=function(e){var t=this.result.linear;t.set(0,0,0);var o=0;return(e.executeForEachCloseEntity(function(e){e instanceof N&&(t.add(e.position),o++)}),0<o)?(J.log("CohesionBehavior","Close entities exist.",e.id),t.multiplyScalar(1/o),e.setTargetPosition(t),q.prototype.compute.call(this,e)):(J.log("CohesionBehavior","No close entities exist.",e.id),this.result)},Object.defineProperty(Se.prototype,"constructor",{value:Se,enumerable:!1,writable:!0});var Be=new u(10),Pe="JumpBehavior",Ie=function(){K.call(this)};Ie.prototype=Object.create(K.prototype),Ie.prototype.compute=function(e){var t=this.result.linear;if(t.set(0,0,0),!e.isJumpReady)return J.log(Pe,"Jump not ready.",e.id),this.result;if(e.isJumpTakenOff)return J.log(Pe,"Jump already took off.",e.id),this.result;var o=e.jumpDescriptor,i=o.getEquationResult(e);if(0==i.time)return J.log(Pe,"Equation result time is zero.",e.id),this.result;var n=Be.get().set(i.vx,0,i.vz);return e.velocity.eql(n)?(e.onJumpTakeOff(),J.log(Pe,"Taking off.",e.id),this.result):(J.log(Pe,"Matching velocity.",e.id),e.velocity.copy(n),this.result)},Object.defineProperty(Ie.prototype,"constructor",{value:Ie,enumerable:!1,writable:!0});var we=function(e){var t=e.graph,o=new M(t),i=[];t.forEachVertex(function(e,t,o){i.push(new c(e,t,o))}),he.call(this,{path:o.path,satisfactionRadius:e.satisfactionRadius}),this.aStar=o,this.allVertices=i,this.isPathConstructed=!1,o.path.finishCallback=function(){this.isPathConstructed=!1}.bind(this)};we.prototype=Object.create(he.prototype),we.prototype.getRandomWaypoint=function(){var e=this.allVertices;return e[o(Math.random()*e.length)]||null},we.prototype.constructPath=function(e){for(var t=!0,o=this.aStar,i=o.graph;t;){var n=i.findClosestVertexToPoint(e.position);n||(n=this.getRandomWaypoint());var r=this.getRandomWaypoint(),a=o.findShortestPath(n,r);t=!a}this.isPathConstructed=!0},we.prototype.compute=function(e){return this.isPathConstructed||(J.log("RandomPathBehavior","Path constructed.",e.id),this.constructPath(e)),J.log("RandomPathBehavior","Following path.",e.id),he.prototype.compute.call(this,e)},Object.defineProperty(we.prototype,"constructor",{value:we,enumerable:!1,writable:!0});var Ce=new x(new c(),new c()),Te=new c,ke=function(e,t,o){this.world=e,this.threeInstance=t,this.scene=o,this.isActive=!1,this.limeMaterial=new t.MeshBasicMaterial({color:"lime",wireframe:!0}),this.magentaMaterial=new t.MeshBasicMaterial({color:"magenta",wireframe:!0}),this.redMaterial=new t.MeshBasicMaterial({color:"red",wireframe:!1}),this.orangeMaterial=new t.MeshBasicMaterial({color:"orange",wireframe:!1}),this.lineMaterial=new t.LineBasicMaterial({color:"cyan"}),this.worldMesh=null,this.meshesByEntityID={},this.velocityMeshesByEntityID={},this.lookMeshesByEntityID={},this.meshesByAStarIDs={},this.meshesByJumpDescriptorIDs={},this.pathMeshes=[],this.edgeMeshes=[],this.LOOK_DISTANCE=100,this.world.onEntityInserted=function(e){this.isActive&&this.addEntity(e)}.bind(this),this.world.onEntityRemoved=function(e){if(this.isActive){var t=this.meshesByEntityID[e.id];if(this.scene.remove(t),delete this.meshesByEntityID[e.id],e instanceof N){var o=this.velocityMeshesByEntityID[e.id];this.scene.remove(o),delete this.velocityMeshesByEntityID[e.id];var i=this.lookMeshesByEntityID[e.id];this.scene.remove(i),delete this.lookMeshesByEntityID[e.id]}}}.bind(this),this.world.onEntityUpdated=function(e){if(this.isActive){var t=this.meshesByEntityID[e.id];t.position.set(e.position.x,e.position.y,e.position.z);var o=t.geometry.parameters;if(t.scale.set(e.size.x/o.width,e.size.y/o.height,e.size.z/o.depth),e instanceof N){var i=this.velocityMeshesByEntityID[e.id];Te.copy(e.position).add(e.velocity),Ce.setFromTwoVectors(e.position,Te,5),Te.x=(Te.x+e.position.x)/2,Te.y=(Te.y+e.position.y)/2,Te.z=(Te.z+e.position.z)/2,i.position.set(Te.x,Te.y,Te.z),i.scale.set(Ce.max.x-Ce.min.x,Ce.max.y-Ce.min.y,Ce.max.z-Ce.min.z);var n=this.lookMeshesByEntityID[e.id];Te.copy(e.lookDirection).normalize().multiplyScalar(this.LOOK_DISTANCE).add(e.position),n.position.set(Te.x,Te.y,Te.z)}}}.bind(this),this.world.onEntityHidden=function(e){if(this.isActive){var t=this.meshesByEntityID[e.id];t.visible=!1}}.bind(this),this.world.onEntityShown=function(e){if(this.isActive){var t=this.meshesByEntityID[e.id];t.visible=!0}}.bind(this),this.world.onEntityLookDirectionUpdated=function(e){if(this.isActive&&e instanceof N){var t=this.lookMeshesByEntityID[e.id];Te.copy(e.lookDirection).normalize().multiplyScalar(this.LOOK_DISTANCE).add(e.position),t.position.set(Te.x,Te.y,Te.z)}}.bind(this)};ke.prototype.visualiseJumpDescriptor=function(e){var t=e._internalID;if(!this.meshesByJumpDescriptorIDs[t]){var o=e.takeoffPosition.clone(),i=e.landingPosition.clone(),n=new c(o.x,o.y+100,o.z),r=new c(i.x,i.y+100,i.z),a=new this.threeInstance.CubicBezierCurve3(o,n,r,i),p=a.getPoints(100),s=new this.threeInstance.BufferGeometry().setFromPoints(p),l=new this.threeInstance.Line(s,this.lineMaterial);this.meshesByJumpDescriptorIDs[t]=l,this.scene.add(l)}},ke.prototype.visualisePath=function(e,t){for(var o=t||5,n=[],r=0;r<e.length;r++){var a=e.waypoints[r],p=new this.threeInstance.Mesh(new this.threeInstance.BoxBufferGeometry(o,o,o),this.orangeMaterial);p.position.set(a.x,a.y,a.z),this.scene.add(p),this.pathMeshes.push(p),n.push(p)}return n},ke.prototype.visualiseAStar=function(e){var t=e._internalID,o=15;this.meshesByAStarIDs[t]||(0<e.searchID&&(this.meshesByAStarIDs[t]=this.visualisePath(e.path,o)),e.onPathConstructed=function(){for(var n,r=this.meshesByAStarIDs[t]||[],a=0;a<r.length;a++)n=r[a],this.scene.remove(n),this.pathMeshes.splice(this.pathMeshes.indexOf(n),1);this.meshesByAStarIDs[t]=this.visualisePath(e.path,o)}.bind(this))},ke.prototype.visualiseGraph=function(e){var t=this.threeInstance,o=this.lineMaterial,i=this.scene,n=this.edgeMeshes;e.forEachEdge(function(e){var r=new t.Geometry;r.vertices.push(e.fromVertex),r.vertices.push(e.toVertex);var a=new t.Line(r,o);i.add(a),n.push(a)})},ke.prototype.addEntity=function(e){var t=this.createMeshFromEntity(e);if(this.meshesByEntityID[e.id]=t,this.scene.add(t),e.isHidden&&(t.visible=!1),e instanceof N){var o=new this.threeInstance.Mesh(new this.threeInstance.BoxBufferGeometry(1,1,1),this.magentaMaterial);o.position.set(e.position.x,e.position.y,e.position.z),this.scene.add(o),this.velocityMeshesByEntityID[e.id]=o;var i=new this.threeInstance.Mesh(new this.threeInstance.BoxBufferGeometry(5,5,5),this.redMaterial),n=new c().copy(e.lookDirection).normalize().add(e.position).multiplyScalar(this.LOOK_DISTANCE);i.position.set(n.x,n.y,n.z),this.scene.add(i),this.lookMeshesByEntityID[e.id]=i}},ke.prototype.activate=function(){this.isActive=!0;var e=new this.threeInstance.BoxBufferGeometry(this.world.width,this.world.height,this.world.depth);this.worldMesh=new this.threeInstance.Mesh(e,this.limeMaterial),this.scene.add(this.worldMesh),this.world.forEachEntity(function(e){this.addEntity(e)}.bind(this))},ke.prototype.deactivate=function(){for(var e in this.isActive=!1,this.scene.remove(this.worldMesh),this.worldMesh=null,this.meshesByEntityID)this.scene.remove(this.meshesByEntityID[e]);for(var e in this.velocityMeshesByEntityID)this.scene.remove(this.velocityMeshesByEntityID[e]);for(var e in this.lookMeshesByEntityID)this.scene.remove(this.lookMeshesByEntityID[e]);for(var t in this.meshesByJumpDescriptorIDs)this.scene.remove(this.meshesByJumpDescriptorIDs[t]);for(var o=0;o<this.pathMeshes.length;o++)this.scene.remove(this.pathMeshes[o]);for(var o=0;o<this.edgeMeshes.length;o++)this.scene.remove(this.edgeMeshes[o]);this.meshesByEntityID={},this.velocityMeshesByEntityID={},this.lookMeshesByEntityID={},this.meshesByAStarIDs={},this.meshesByJumpDescriptorIDs={},this.pathMeshes=[],this.edgeMeshes=[]},ke.prototype.createMeshFromEntity=function(e){var t=new this.threeInstance.BoxBufferGeometry(e.size.x,e.size.y,e.size.z),o=new this.threeInstance.Mesh(t,this.limeMaterial);return o.position.set(e.position.x,e.position.y,e.position.z),o},e.MathUtils=h,e.Vector3D=c,e.VectorPool=u,e.Box=x,e.World=w,e.Entity=B,e.Quaternion=z,e.Path=C,e.Edge=T,e.Graph=k,e.MinHeap=R,e.AStar=M,e.Vertex=I,e.Steerable=N,e.SteerResult=_,e.JumpDescriptor=W,e.SteeringBehavior=K,e.SeekBehavior=q,e.ArriveBehavior=Y,e.AvoidBehavior=$,e.BlendedSteeringBehavior=te,e.PursueBehavior=ie,e.LookWhereYouAreGoingBehavior=re,e.Wander2DBehavior=se,e.Wander3DBehavior=de,e.FleeBehavior=ye,e.EvadeBehavior=ce,e.PathFollowingBehavior=he,e.PrioritySteeringBehavior=ge,e.HideBehavior=fe,e.RandomWaypointBehavior=be,e.SeparationBehavior=Ee,e.AlignBehavior=De,e.CohesionBehavior=Se,e.JumpBehavior=Ie,e.RandomPathBehavior=we,e.DebugHelper=ke,e.logger=J,Object.defineProperty(e,"__esModule",{value:!0})});