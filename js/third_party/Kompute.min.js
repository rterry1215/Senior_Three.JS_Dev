(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Kompute=e.Kompute||{})})(this,function(e){'use strict';var t=Math.cos,o=Math.floor,i=Math.sin,n=Number.EPSILON,a=Math.abs,p=Math.round,l=Math.sqrt,y=Math.max,d=Math.min,c=function(e,t,o){this.x=e||0,this.y=t||0,this.z=o||0};c.prototype.set=function(e,t,o){return this.x=e,this.y=t,this.z=o,this},c.prototype.copy=function(e){return this.set(e.x,e.y,e.z)},c.prototype.clone=function(){return new c().copy(this)},c.prototype.multiplyScalar=function(e){return this.set(this.x*e,this.y*e,this.z*e),this},c.prototype.min=function(e){return this.x=d(this.x,e.x),this.y=d(this.y,e.y),this.z=d(this.z,e.z),this},c.prototype.max=function(e){return this.x=y(this.x,e.x),this.y=y(this.y,e.y),this.z=y(this.z,e.z),this},c.prototype.getLength=function(){return l(this.x*this.x+this.y*this.y+this.z*this.z)},c.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},c.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},c.prototype.normalize=function(){var e=this.getLength();return 0==e?this:(this.x/=e,this.y/=e,this.z/=e,this)},c.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},c.prototype.applyQuaternion=function(e){var t=this.x,o=this.y,i=this.z,n=e.x,r=e.y,a=e.z,p=e.w,s=p*t+r*i-a*o,l=p*o+a*t-n*i,y=p*i+n*o-r*t,d=-n*t-r*o-a*i;return this.x=s*p+d*-n+l*-a-y*-r,this.y=l*p+d*-r+y*-n-s*-a,this.z=y*p+d*-a+s*-r-l*-n,this},c.prototype.cross=function(e){return this.set(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},c.prototype.negate=function(){return this.set(-this.x,-this.y,-this.z)},c.prototype.eql=function(e){return e.x==this.x&&e.y==this.y&&e.z==this.z},c.prototype.toFixed=function(e){return this.set(this.x.toFixed(e),this.y.toFixed(e),this.z.toFixed(e))},c.prototype.getDistanceSq=function(e){var t=this.x-e.x,o=this.y-e.y,i=this.z-e.z;return t*t+o*o+i*i};var u=function(e){this.index=0,this.vectors=[];for(var t=0;t<e;t++)this.vectors.push(new c)};u.prototype.get=function(){var e=this.vectors[this.index++];return this.index==this.vectors.length&&(this.index=0),e};var g=new u(10),m=function(){};m.prototype.clamp=function(e,t,o){return y(t,d(o,e))};var h=new u(10),x=function(e,t){this.min=new c,this.max=new c,this.setFromCenterAndSize(e,t)};x.prototype.setFromCenterAndSize=function(e,t){var o=h.get().copy(t).multiplyScalar(.5);return this.min.set(e.x-o.x,e.y-o.y,e.z-o.z),this.max.set(e.x+o.x,e.y+o.y,e.z+o.z),this},x.prototype.makeEmpty=function(){return this.min.set(1/0,1/0,1/0),this.max.set(-Infinity,-Infinity,-Infinity),this},x.prototype.expandByPoint=function(e){return this.min.min(e),this.max.max(e),this},x.prototype.intersectsBox=function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},x.prototype.containsBox=function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},x.prototype.setFromTwoVectors=function(e,t,o){this.makeEmpty(),this.expandByPoint(e),this.expandByPoint(t);var i=h.get().copy(e);return i.x=e.x+o,this.expandByPoint(i),i.x=e.x-o,this.expandByPoint(i),i.x=e.x,i.y=e.y+o,this.expandByPoint(i),i.y=e.y-o,this.expandByPoint(i),i.y=e.y,i.z=e.z+o,this.expandByPoint(i),i.z=e.z-o,this.expandByPoint(i),i.copy(t),i.x=t.x+o,this.expandByPoint(i),i.x=t.x-o,this.expandByPoint(i),i.x=t.x,i.y=t.y+o,this.expandByPoint(i),i.y=t.y-o,this.expandByPoint(i),i.y=t.y,i.z=t.z+o,this.expandByPoint(i),i.z=t.z-o,this.expandByPoint(i),this},x.prototype.isEmpty=function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},x.prototype.getBoundingRadius=function(){var e=h.get().set(0,0,0);return this.isEmpty()||e.copy(this.max).sub(this.min),.5*e.getLength()};var v=function(e,t,o,i){this.limitBox=this.createBox(0,0,0,e,t,o),this.binSize=i,this.bin=new Map,this.reusableResultMap=new Map};v.prototype.createBox=function(e,t,o,i,n,r){var a={};return a.containsBox=function(e){return this.minX<=e.minX&&e.maxX<=this.maxX&&this.minY<=e.minY&&e.maxY<=this.maxY&&this.minZ<=e.minZ&&e.maxZ<=this.maxZ},a.setFromCenterAndSize=function(e,t,o,i,n,r){var a=i/2,p=n/2,s=r/2;this.minX=e-a,this.maxX=e+a,this.minY=t-p,this.maxY=t+p,this.minZ=o-s,this.maxZ=o+s},a.setFromCenterAndSize(e,t,o,i,n,r),a},v.prototype.createObject=function(e,t){var o=this,i={id:e,box:t,binInfo:new Map};return i},v.prototype.insert=function(e){if(this.limitBox.containsBox(e.box)){var t,o,i=this.binSize,n=e.box,r=n.minX,a=n.minY,s=n.minZ,l=n.maxX,d=n.maxY,c=n.maxZ,u=p(r/i)*i;u<=r?(t=u,o=t+i):(o=u,t=u-i),u=p(l/i)*i;var g,m;u<l?(g=u,m=g+i):(m=u,g=u-i),t>g&&(g=t),u=p(a/i)*i;var h,v;u<=a?(h=u,v=h+i):(v=u,h=u-i),u=p(d/i)*i;var f,b;u<d?(f=u,b=f+i):(b=u,f=u-i),h>f&&(f=h),u=p(s/i)*i;var E,S;u<=s?(E=u,S=E+i):(S=u,E=u-i),u=p(c/i)*i;var w,P;u<c?(w=u,P=w+i):(P=u,w=u-i),E>w&&(w=E);for(var D=t;D<=g;D+=i)for(var B=h;B<=f;B+=i)for(var C=E;C<=w;C+=i)this.bin.has(D)||this.bin.set(D,new Map),this.bin.get(D).has(B)||this.bin.get(D).set(B,new Map),this.bin.get(D).get(B).has(C)||this.bin.get(D).get(B).set(C,new Map),this.bin.get(D).get(B).get(C).set(e,!0),e.binInfo.has(D)||e.binInfo.set(D,new Map),e.binInfo.get(D).has(B)||e.binInfo.get(D).set(B,new Map),e.binInfo.get(D).get(B).set(C,!0)}},v.prototype.query=function(e,t,o){var i,n,r=this.binSize,a=p(e/r)*r,s=p(t/r)*r,l=p(o/r)*r;a<=e?(i=a,n=a+r):(n=a,i=a-r);var y,d;s<=t?(y=s,d=s+r):(d=s,y=s-r);var c,u;l<=o?(c=l,u=l+r):(u=l,c=l-r);var g=this.reusableResultMap;g.clear();for(var m=-r;m<=r;m+=r)for(var h=-r;h<=r;h+=r)for(var x=-r;x<=r;x+=r){var v=i+m,f=y+h,z=c+x;if(this.bin.has(v)&&this.bin.get(v).has(f)){var b=this.bin.get(v).get(f).get(z);if(b){var E=!0,S=!1,w=void 0;try{for(var P,D,B=b.keys()[Symbol.iterator]();!(E=(P=B.next()).done);E=!0)D=P.value,g.set(D,!0)}catch(e){S=!0,w=e}finally{try{!E&&B.return&&B.return()}finally{if(S)throw w}}}}}return g},v.prototype.delete=function(e){var t=e.binInfo,o=!0,i=!1,n=void 0;try{for(var r,a=t.keys()[Symbol.iterator]();!(o=(r=a.next()).done);o=!0){var p=r.value,s=!0,l=!1,d=void 0;try{for(var c,u=t.get(p).keys()[Symbol.iterator]();!(s=(c=u.next()).done);s=!0){var g=c.value,y=!0,m=!1,h=void 0;try{for(var v,f,b=t.get(p).get(g).keys()[Symbol.iterator]();!(y=(v=b.next()).done);y=!0)f=v.value,this.bin.has(p)&&this.bin.get(p).has(g)&&this.bin.get(p).get(g).has(f)&&(this.bin.get(p).get(g).get(f).delete(e),0==this.bin.get(p).get(g).get(f).size&&this.bin.get(p).get(g).delete(f),0==this.bin.get(p).get(g).size&&this.bin.get(p).delete(g),0==this.bin.get(p).size&&this.bin.delete(p))}catch(e){m=!0,h=e}finally{try{!y&&b.return&&b.return()}finally{if(m)throw h}}}}catch(e){l=!0,d=e}finally{try{!s&&u.return&&u.return()}finally{if(l)throw d}}}}catch(e){i=!0,n=e}finally{try{!o&&a.return&&a.return()}finally{if(i)throw n}}var E=!0,S=!1,w=void 0;try{for(var P,p,D=t.keys()[Symbol.iterator]();!(E=(P=D.next()).done);E=!0)p=P.value,t.delete(p)}catch(e){S=!0,w=e}finally{try{!E&&D.return&&D.return()}finally{if(S)throw w}}},v.prototype.update=function(e,t,o,i,n,r,a){e.box.setFromCenterAndSize(t,o,i,n,r,a),this.delete(e),this.insert(e)};var f=new u(10),z=new m,b=function(e,t,o,i){this.set(e||0,t||0,o||0,i===void 0?1:i)};b.prototype.set=function(e,t,o,i){return this.x=e,this.y=t,this.z=o,this.w=i,this},b.prototype.copy=function(e){return this.set(e.x,e.y,e.z,e.w),this},b.prototype.clone=function(){return new b().copy(this)},b.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},b.prototype.radialDistanceTo=function(e){return 2*Math.acos(a(z.clamp(this.dot(e),-1,1)))},b.prototype.getLength=function(){return l(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},b.prototype.normalize=function(){var e=this.getLength();return 0==e?this.set(0,0,0,1):this.set(this.x/e,this.y/e,this.z/e,this.w/e)},b.prototype.sphericalLinearInterpolation=function(e,o){var t=Math.atan2;if(0==o)return this;if(1==o)return this.copy(e);var r=this.x,a=this.y,p=this.z,y=this.w,d=y*e.w+r*e.x+a*e.y+p*e.z;if(0>d?(this.set(-e.x,-e.y,-e.z,-e.w),d=-d):this.copy(e),1<=d)return this.set(r,a,p,y);var c=1-d*d;if(c<n){var u=1-o;return this.set(u*r+o*this.x,u*a+o*this.y,u*p+o*this.z,u*y+o*this.w).normalize()}var s=l(c),g=t(s,d),m=i((1-o)*g)/s,h=i(o*g)/s;return this.set(r*m+this.x*h,a*m+this.y*h,p*m+this.z*h,y*m+this.w*h)},b.prototype.rotateTowards=function(e,t){var o=this.radialDistanceTo(e);return 0==o?this:this.sphericalLinearInterpolation(e,d(1,t/o))},b.prototype.setFromVectors=function(e,t){var o=f.get().copy(e).normalize(),i=f.get().copy(t).normalize(),p=o.dot(i)+1;return p<n?a(o.x)>a(i.z)?this.set(-o.y,o.x,0,0):this.set(0,-o.z,o.y,0):this.set(o.y*i.z-o.z*i.y,o.z*i.x-o.x*i.z,o.x*i.y-o.y*i.x,p),this.normalize()};var E=new b,S=new b,w=new u(10),P=function(e,t,o){this.id=e,this.size=o.clone(),this.position=t.clone(),this.world=null,this.box=new x(t,o),this.nearbyObject=null,this.maxSpeed=1/0,this.velocity=new c,this.hasLookTarget=!1,this.lookTarget=new c,this.lookSpeed=.1,this.lookDirection=new c(0,0,-1)};P.prototype.update=function(){var e=this.velocity.getLength();e>this.maxSpeed&&this.velocity.copy(this.velocity.normalize().multiplyScalar(this.maxSpeed));var t=w.get().copy(this.velocity).multiplyScalar(1/60);if(this.setPosition(this.position.add(t)),this.hasLookTarget){var o=w.get().copy(this.lookTarget).sub(this.position),i=E.setFromVectors(this.lookDirection,o);S.set(0,0,0,1);var n=w.get().copy(this.lookDirection).applyQuaternion(S.rotateTowards(E,this.lookSpeed));this.setLookDirection(n)}},P.prototype.setPositionAndSize=function(e,t){this.setPosition(e,!0),this.setSize(t)},P.prototype.setSize=function(e,t){this.size.copy(e),this.box.setFromCenterAndSize(this.position,e),this.world&&!t&&this.world.updateEntity(this,this.position,this.size)},P.prototype.setPosition=function(e,t){this.position.copy(e),this.box.setFromCenterAndSize(e,this.size),this.world&&!t&&this.world.updateEntity(this,this.position,this.size)},P.prototype.setLookDirection=function(e){this.lookDirection.copy(w.get().copy(e).normalize()),this.world&&this.world.onLookDirectionUpdated(this)},P.prototype.executeForEachCloseEntity=function(e){if(this.world){var t=this.world.getNearbyObjects(this.position),o=!0,i=!1,n=void 0;try{for(var r,a,p=t[Symbol.iterator]();!(o=(r=p.next()).done);o=!0)if(a=r.value,a.id!=this.id&&e(this.world.getEntityByID(a.id)))return}catch(e){i=!0,n=e}finally{try{!o&&p.return&&p.return()}finally{if(i)throw n}}}},P.prototype.setLookTarget=function(e){this.lookTarget.copy(e),this.hasLookTarget=!0},P.prototype.unsetLookTarget=function(){this.hasLookTarget=!1},P.prototype.isNearTo=function(e){var t=!1;return this.executeForEachCloseEntity(function(o){if(o===e)return t=!0,!0}),t};var D=new c(1,1,1),B=function(e,t){var o=e.clone(),i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),o="x"==e?t:8|3&t;return o.toString(16)});P.call(this,"vertex#"+i,o,D),this.position=o,this.graph=t};B.prototype=Object.create(P.prototype),Object.defineProperty(B.prototype,"constructor",{value:B,enumerable:!1,writable:!0});var C=function(e,t,o,i){this.width=e,this.height=t,this.depth=o,this.nearby=new v(e,t,o,i),this.entititesByID={},this.gravity=0};C.prototype.setGravity=function(e){this.gravity=e},C.prototype.getEntityByID=function(e){return this.entititesByID[e]||null},C.prototype.insertGraph=function(e){if(!e.world){var t=this;e.forEachVertex(function(o,i,n){var r=new B(new c(o,i,n),e);t.insertEntity(r),e.vertexIDs.push(r.id)}),e.world=this}},C.prototype.removeGraph=function(e){if(e.world){for(var t=0;t<e.vertexIDs.length;t++){var o=e.vertexIDs[t],n=this.getEntityByID(o);this.removeEntity(n)}e.world=null,e.vertexIDs=[]}},C.prototype.insertEntity=function(e){this.entititesByID[e.id]=e;var t=e.position,o=e.size,i=this.nearby.createBox(t.x,t.y,t.z,o.x,o.y,o.z),n=this.nearby.createObject(e.id,i);this.nearby.insert(n),e.world=this,e.nearbyObject=n,e.lastWorldPosition=t.clone(),e.lastWorldSize=o.clone(),this.onEntityInserted&&this.onEntityInserted(e)},C.prototype.updateEntity=function(e,t,o){e.lastWorldPosition.eql(t)&&e.lastWorldSize.eql(o)||(this.nearby.update(e.nearbyObject,t.x,t.y,t.z,o.x,o.y,o.z),this.onEntityUpdated&&this.onEntityUpdated(e),e.lastWorldPosition.copy(t),e.lastWorldSize.copy(o))},C.prototype.onLookDirectionUpdated=function(e){this.onEntityLookDirectionUpdated&&this.onEntityLookDirectionUpdated(e)},C.prototype.removeEntity=function(e){delete this.entititesByID[e.id],this.nearby.delete(e.nearbyObject),this.onEntityRemoved&&this.onEntityRemoved(e),delete e.lastWorldPosition,delete e.lastWorldSize},C.prototype.getNearbyObjects=function(e){return this.nearby.query(e.x,e.y,e.z).keys()},C.prototype.forEachEntity=function(e){for(var t in this.entititesByID){var o=this.entititesByID[t];e(o)}};var I=function(e){if(e=e||{},this.index=0,this.length=0,this.jumpDescriptorLength=0,this.loop=!!e.loop,this.rewind=!!e.rewind,this.isRewinding=!1,this.isFinished=!1,this.waypoints=[],this.jumpDescriptors=[],e.fixedLength)for(var t=0;t<e.fixedLength;t++)this.waypoints.push(new c),this.jumpDescriptors.push(null);this.options=JSON.parse(JSON.stringify(e))};I.prototype.clone=function(){var e=new I(this.options);if(!this.options.fixedLength){for(var t=0;t<this.waypoints.length;t++)e.addWaypoint(this.waypoints[t]);for(var t=0;t<this.jumpDescriptors.length;t++)e.addJumpDescriptor(this.jumpDescriptors[t])}else{for(var t=0;t<this.length;t++)e.insertWaypoint(this.waypoints[t]);for(var t=0;t<this.jumpDescriptorLength;t++)e.insertJumpDescriptor(this.jumpDescriptors[t])}return e},I.prototype.restart=function(){this.isRewinding=!1,this.isFinished=!1,this.index=0},I.prototype.insertJumpDescriptor=function(e){this.jumpDescriptors[this.jumpDescriptorLength++]=e},I.prototype.addJumpDescriptor=function(e){var t=e.takeoffPosition,o=e.landingPosition,i=this.getWaypointIndex(t);if(null==i)return!1;var n=this.getWaypointIndex(o);return null!=n&&!(i>=n)&&(this.jumpDescriptors.push(e),this.jumpDescriptorLength++,!0)},I.prototype.getWaypointIndex=function(e){var t=this.length,o=this.waypoints.findIndex(function(o,i){return i<t&&o.eql(e)});return-1==o?null:o},I.prototype.insertWaypoint=function(e){this.waypoints[this.length++].copy(e)},I.prototype.addWaypoint=function(e){this.waypoints.push(e.clone()),this.length++},I.prototype.getCurrentWaypoint=function(){return!this.isFinished&&(this.waypoints[this.index]||!1)},I.prototype.onFinished=function(){this.finishCallback&&this.finishCallback()},I.prototype.next=function(){if(!this.isFinished){var e=this.length;this.isRewinding?(this.index--,-1==this.index&&(this.loop?(this.index=1,this.isRewinding=!1):(this.isFinished=!0,this.onFinished()))):(this.index++,this.index==e&&(this.rewind?(this.index=e-2,this.isRewinding=!0):this.loop?this.index=0:(this.isFinished=!0,this.onFinished())))}},I.prototype.getRandomWaypoint=function(){return this.waypoints[o(Math.random()*this.length)]||null};var T=function(e,t){this.fromVertex=e.clone(),this.toVertex=t.clone(),this.cost=e.clone().sub(t).getLength(),this.jumpDescriptor=null};T.prototype.clone=function(){return new T(this.fromVertex,this.toVertex)};var k=function(){this.world=null,this.connections={},this.totalVertexCount=0,this.vertexIDs=[]};k.prototype.clone=function(){var e=new k;return this.forEachVertex(function(t,o,i){e.addVertex(new c(t,o,i))}),this.forEachEdge(function(t){e.addEdge(t.fromVertex,t.toVertex)}),e},k.prototype.findClosestVertexToPoint=function(e){var t=this.world;if(!t)return null;var o=1/0,i=null,n=this.world.getNearbyObjects(e),r=!0,a=!1,p=void 0;try{for(var s,l=n[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var y=s.value,d=t.getEntityByID(y.id);if(d instanceof B&&d.graph===this){var c=e.getDistanceSq(d.position);c<o&&(i=d,o=c)}}}catch(e){a=!0,p=e}finally{try{!r&&l.return&&l.return()}finally{if(a)throw p}}return i?i.position:null},k.prototype.addVertex=function(e){if(this.hasVertex(e))return!1;var t=e.x,o=e.y,i=e.z;return this.connections[t]||(this.connections[t]={}),this.connections[t][o]||(this.connections[t][o]={}),this.connections[t][o][i]||(this.connections[t][o][i]=[]),this.totalVertexCount++,!0},k.prototype.removeVertex=function(e){if(!this.hasVertex(e))return!1;var t=e.x,o=e.y,n=e.z;for(var t in delete this.connections[t][o][n],0==Object.keys(this.connections[t][o]).length&&delete this.connections[t][o],0==Object.keys(this.connections[t]).length&&delete this.connections[t],this.connections)for(var o in this.connections[t])for(var n in this.connections[t][o]){for(var r=this.connections[t][o][n],a=-1,p=0;p<r.length;p++){var s=r[p],l=s.toVertex;if(l.x==e.x&&l.y==e.y&&l.z==e.z){a=p;break}}-1!=a&&(r.splice(a,1),this.connections[t][o][n]=r)}return this.totalVertexCount--,!0},k.prototype.hasVertex=function(e){var t=e.x,o=e.y,i=e.z;return!!(this.connections[t]&&this.connections[t][o]&&this.connections[t][o][i])},k.prototype.addEdge=function(e,t){if(!this.hasVertex(e)||!this.hasVertex(t))return!1;for(var o,n=this.connections[e.x][e.y][e.z],r=0;r<n.length;r++)if(o=n[r].toVertex,o.x==t.x&&o.y==t.y&&o.z==t.z)return!1;var a=new T(e,t);return n.push(a),!0},k.prototype.addJumpDescriptor=function(e){var t=e.takeoffPosition,o=e.landingPosition;if(!this.hasVertex(t)||!this.hasVertex(o))return!1;for(var n,r=this.connections[t.x][t.y][t.z],a=null,p=0;p<r.length;p++)if(n=r[p].toVertex,n.x==o.x&&n.y==o.y&&n.z==o.z){a=r[p];break}return a?a.jumpDescriptor=e:(a=new T(t,o),a.jumpDescriptor=e,r.push(a)),!0},k.prototype.removeEdge=function(e,t){if(!this.hasVertex(e)||!this.hasVertex(t))return!1;for(var o=this.connections[e.x][e.y][e.z],n=-1,r=0;r<o.length;r++){var a=o[r],p=a.toVertex;if(p.x==t.x&&p.y==t.y&&p.z==t.z){n=r;break}}return-1!=n&&(o.splice(n,1),this.connections[e.x][e.y][e.z]=o,!0)},k.prototype.forEachNeighbor=function(e,t){if(this.hasVertex(e))for(var o,n=this.connections[e.x][e.y][e.z],r=0;r<n.length;r++)o=n[r],t(o.toVertex,o.cost,o.jumpDescriptor)},k.prototype.forEachVertex=function(e){for(var t in this.connections)for(var o in this.connections[t])for(var i in this.connections[t][o])e(parseFloat(t),parseFloat(o),parseFloat(i))},k.prototype.forEachEdge=function(e){for(var t in this.connections)for(var o in this.connections[t])for(var n in this.connections[t][o])for(var r=this.connections[t][o][n],a=0;a<r.length;a++)e(r[a])};var R=function(e){this.data=[];for(var t=0;t<e;t++)this.data.push(null);this.length=0,this.HEAP_CHECK_RESULT_OK=0,this.HEAP_CHECK_RESULT_LEFT=1,this.HEAP_CHECK_RESULT_RIGHT=2};R.prototype.reset=function(){for(var e=0;e<this.data.length;e++)this.data[e]=null;this.length=0},R.prototype.peek=function(){return this.data[0]},R.prototype.getParentIndex=function(e){return o(e/2)},R.prototype.getLeftChildIndex=function(e){return this.getRightChildIndex(e)-1},R.prototype.getRightChildIndex=function(e){return 2*(e+1)},R.prototype.insert=function(e){if(this.data.length==this.length)return!1;var t=this.length,o=this.getParentIndex(this.length);this.data[t]=e;for(var i=this.data[o];i&&e.priority<i.priority;)this.data[o]=e,this.data[t]=i,t=o,o=this.getParentIndex(t),i=this.data[o];return this.length++,!0},R.prototype.remove=function(e){var t=this.data.indexOf(e);if(-1==t)return!1;var o=this.length-1;return this.swap(t,o),this.data[o]=null,this.length--,this.reconstruct(t),!0},R.prototype.heapCheck=function(e){var t=this.data[e];if(!t)return this.HEAP_CHECK_RESULT_OK;var o=this.getLeftChildIndex(e),i=this.getRightChildIndex(e),n=this.data[o],r=this.data[i];if(!n&&!r)return this.HEAP_CHECK_RESULT_OK;return r?t.priority<=n.priority&&t.priority<=r.priority?this.HEAP_CHECK_RESULT_OK:n.priority<=t.priority&&n.priority<=r.priority?this.HEAP_CHECK_RESULT_LEFT:this.HEAP_CHECK_RESULT_RIGHT:t.priority<=n.priority?this.HEAP_CHECK_RESULT_OK:this.HEAP_CHECK_RESULT_LEFT},R.prototype.swap=function(e,t){var o=this.data[e],i=this.data[t];this.data[e]=i,this.data[t]=o},R.prototype.pop=function(){if(0==this.length)return!1;var e=this.data[0],t=this.length-1;return this.data[0]=this.data[t],this.data[t]=null,this.length--,this.reconstruct(0),e},R.prototype.reconstruct=function(e){for(var t=this.heapCheck(e);t!=this.HEAP_CHECK_RESULT_OK;){if(t==this.HEAP_CHECK_RESULT_LEFT){var o=this.getLeftChildIndex(e);this.swap(e,o),e=o}else{var i=this.getRightChildIndex(e);this.swap(e,i),e=i}t=this.heapCheck(e)}},R.prototype.hasNode=function(e){return 0<=this.data.indexOf(e)};var L=new u(10),M=function(e){var t=new I({fixedLength:e.totalVertexCount}),o={};e.forEachVertex(function(e,t,i){o[e]||(o[e]={}),o[e][t]||(o[e][t]={}),o[e][t][i]||(o[e][t][i]={priority:0,parent:null,x:parseFloat(e),y:parseFloat(t),z:parseFloat(i),closedTag:null,parentTag:null,jumpDescriptor:null})}),this.heapNodes=o,this.path=t,this.graph=e,this.heap=new R(e.totalVertexCount),this.searchID=0};M.prototype.getHeapNode=function(e,t,o,i){var n=i?i[e]:this.heapNodes[e];if(n){var r=n[t];return r?r[o]||null:null}return null},M.prototype.isNodeBelongToVector=function(e,t){return e===this.getHeapNode(t.x,t.y,t.z)},M.prototype.generatePath=function(e){var t=this.path;t.length=0;for(var o=e,i=this.getHeapNode(o.x,o.y,o.z);i;){t.insertWaypoint(o);var n=i.jumpDescriptor;n&&t.insertJumpDescriptor(n);var r=i.parentTag;i=i.parent,i&&r!=this.searchID&&(i=null),i&&(o=L.get().set(i.x,i.y,i.z))}return t.isRewinding=!0,t.index=t.length-1,t.isFinished=!1,t},M.prototype.markNodeAsClosed=function(e,t){e.closedTag=t},M.prototype.isNodeClosed=function(e,t){return e.closedTag===t},M.prototype.findShortestPath=function(e,t){var o=this.heapNodes;this.searchID++;var i=this.searchID,n=this.heap;n.reset();var r=this.graph;if(!r.hasVertex(e)||!r.hasVertex(t))return!1;var a=this.getHeapNode,p=this.isNodeClosed,s=this.markNodeAsClosed,l=this.getHeapNode(e.x,e.y,e.z),y=L.get();for(n.insert(l);l;){if(this.isNodeBelongToVector(l,t))return this.generatePath(t);s(l,i),y.set(l.x,l.y,l.z),r.forEachNeighbor(y,function(e,r,y){var d=a(e.x,e.y,e.z,o),c=e.getDistanceSq(t);if(p(d,i)||(d.priority=r+c,d.parent=l,d.parentTag=i,d.jumpDescriptor=y,s(d,i),n.insert(d)),n.hasNode(d)){var u=c+r;u<d.priority&&(d.priority=u,d.parent=l,d.parentTag=i,d.jumpDescriptor=y,n.remove(d),n.insert(d))}}),l=n.pop()}return!1};var A=function(){this.logMethod=console.log,this.isEnabled=!1,this.lastMessageMap={}};A.prototype.enable=function(){this.isEnabled=!0},A.prototype.disable=function(){this.isEnabled=!1},A.prototype.log=function(e,t,o){this.isEnabled&&this.lastMessageMap[o]!=t&&(this.logMethod("["+e+"]: "+t+" ("+o+")"),this.lastMessageMap[o]=t)};var j=new A,J="Steerable",V=1/60,F=new u(10),H=function(e,t,o){P.call(this,e,t,o),this.hasTargetPosition=!1,this.hasTargetEntity=!1,this.hasHideTargetEntity=!1,this.targetPosition=new c,this.targetEntity=null,this.hideTargetEntity=null,this.linearAcceleration=new c,this.maxAcceleration=1/0,this.isJumpInitiated=!1,this.isJumpReady=!1,this.isJumpTakenOff=!1,this.jumpSpeed=1/0,this.jumpTime=0};H.prototype=Object.create(P.prototype),H.prototype.update=function(){if(!this.world)return void j.log(J,"Not inserted to a world.",this.id);if(!this.behavior)return void j.log(J,"Has no behavior.",this.id);var e=this.behavior.compute(this);this.linearAcceleration.copy(e.linear);var t=this.linearAcceleration.getLength();t>this.maxAcceleration&&this.linearAcceleration.copy(this.linearAcceleration.normalize().multiplyScalar(this.maxAcceleration)),this.isJumpTakenOff&&(this.linearAcceleration.y+=this.world.gravity,this.jumpTime+=V,this.jumpTime>=this.jumpDescriptor.getEquationResult(this).time&&(j.log(J,"Jump completed.",this.id),this.onJumpCompleted()));var o=F.get().copy(this.linearAcceleration).multiplyScalar(V);if(this.velocity.add(o),P.prototype.update.call(this),this.isJumpInitiated&&!this.isJumpTakenOff&&!this.isJumpReady){var i=F.get().copy(this.position).sub(this.jumpDescriptor.takeoffPosition).getLength();i<this.jumpDescriptor.runupSatisfactionRadius&&(j.log(J,"Jump ready.",this.id),this.onJumpReady())}},H.prototype.setJumpBehavior=function(e){this.isJumpInitiated||(this.jumpBehavior=e)},H.prototype.setBehavior=function(e){this.isJumpInitiated||(this.behavior=e)},H.prototype.unsetTargetPosition=function(){this.isJumpInitiated||(this.hasTargetPosition=!1)},H.prototype.setTargetPosition=function(e){this.isJumpInitiated||(this.targetPosition.copy(e),this.hasTargetPosition=!0)},H.prototype.setTargetEntity=function(e){this.isJumpInitiated||(this.targetEntity=e,this.hasTargetEntity=!0)},H.prototype.unsetTargetEntity=function(){this.isJumpInitiated||(this.hasTargetEntity=!1,this.targetEntity=null)},H.prototype.setHideTargetEntity=function(e){this.isJumpInitiated||(this.hideTargetEntity=e,this.hasHideTargetEntity=!0)},H.prototype.unsetHideTargetEntity=function(){this.isJumpInitiated||(this.hasHideTargetEntity=!1,this.hideTargetEntity=null)},H.prototype.jump=function(e,t){var o=t.solveQuadraticEquation(this);return o?(this.isJumpInitiated=!1,this.isJumpReady=!1,this.isJumpTakenOff=!1,this.unsetTargetEntity(),this.unsetHideTargetEntity(),this.setTargetPosition(t.takeoffPosition),this.setBehavior(e),this.jumpDescriptor=t,this.isJumpInitiated=!0,this.jumpTime=0,j.log(J,"Jump initiated.",this.id),!0):(j.log(J,"Equation cannot be solved.",this.id),!1)},H.prototype.onJumpReady=function(){this.isJumpReady=!0,this.isJumpInitiated=!1,this.setBehavior(this.jumpBehavior),this.isJumpInitiated=!0,this.jumpBehavior||j.log(J,"No jump behavior set.",this.id)},H.prototype.onJumpTakeOff=function(){this.isJumpTakenOff=!0;var e=this.jumpDescriptor,t=e.getEquationResult(this);this.velocity.set(t.vx,this.jumpSpeed,t.vz)},H.prototype.onJumpCompleted=function(){this.jumpTime=0,this.isJumpInitiated=!1,this.isJumpReady=!1,this.isJumpTakenOff=!1,this.position.y=this.jumpDescriptor.landingPosition.y,this.velocity.set(0,0,0),this.linearAcceleration.set(0,0,0),this.jumpCompletionCallback&&this.jumpCompletionCallback(this)},H.prototype.setJumpCompletionListener=function(e){this.jumpCompletionCallback=e},H.prototype.removeJumpCompletionListener=function(){this.jumpCompletionCallback=null},Object.defineProperty(H.prototype,"constructor",{value:H,enumerable:!1,writable:!0});var N=function(){this.linear=new c},_=function(e){this.takeoffPosition=e.takeoffPosition.clone(),this.landingPosition=e.landingPosition.clone(),this.runupSatisfactionRadius=e.runupSatisfactionRadius,this.takeoffPositionSatisfactionRadius=e.takeoffPositionSatisfactionRadius,this.takeoffVelocitySatisfactionRadius=e.takeoffVelocitySatisfactionRadius,this.delta=this.landingPosition.clone().sub(this.takeoffPosition),this.checkTimeResult={vx:0,vz:0,isAchievable:!1},this.cache={}};_.prototype.getEquationResult=function(e){var t=e.jumpSpeed,o=e.maxSpeed,i=e.world.gravity,n=this.cache;return n[t]&&n[t][o]&&n[t][o][i]?n[t][o][i]:null},_.prototype.setCache=function(e,t){var o=e.jumpSpeed,i=e.maxSpeed,n=e.world.gravity,r=this.cache;r[o]||(r[o]={}),r[o][i]||(r[o][i]={}),r[o][i][n]||(r[o][i]={}),r[o][i][n]=t},_.prototype.solveQuadraticEquation=function(e){var t=this.getEquationResult(e);if(t)return t;t={time:0,vx:0,vz:0,isAchievable:!1},this.setCache(e,t),t.isAchievable=!1;var o=e.jumpSpeed,i=e.maxSpeed,n=e.world,r=n.gravity,a=2*r*this.delta.y+o*o,p=l(a),s=(-o+p)/r,y=this.checkTime(s,i);return t.time=s,t.vx=y.vx,t.vz=y.vz,t.isAchievable=y.isAchievable,y.isAchievable||(s=(-o-p)/r,y=this.checkTime(s,i),t.time=s,t.vx=y.vx,t.vz=y.vz,t.isAchievable=y.isAchievable),!!t.isAchievable&&t},_.prototype.checkTime=function(e,t){this.checkTimeResult.isAchievable=!1;var o=this.delta.x/e,i=this.delta.z/e;return o*o+i*i<=t*t&&(this.checkTimeResult.isAchievable=!0,this.checkTimeResult.vx=o,this.checkTimeResult.vz=i),this.checkTimeResult};var O=function(){this.result=new N};O.prototype.compute=function(){return this.result.linear.set(0,0,0),this.result};var W=function(){O.call(this)};W.prototype=Object.create(O.prototype),W.prototype.compute=function(e){return(this.result.linear.set(0,0,0),!e.hasTargetPosition)?(j.log("SeekBehavior","No target position.",e.id),this.result):(this.result.linear.copy(e.targetPosition).sub(e.position).normalize().multiplyScalar(e.maxAcceleration),j.log("SeekBehavior","Speeding up.",e.id),this.result)},Object.defineProperty(W.prototype,"constructor",{value:W,enumerable:!1,writable:!0});var K=new u(10),U="ArriveBehavior",q=function(e){O.call(this),this.satisfactionRadius=e.satisfactionRadius,this.slowDownRadius=e.slowDownRadius};q.prototype=Object.create(O.prototype),q.prototype.compute=function(e){if(this.result.linear.set(0,0,0),!e.hasTargetPosition)return j.log(U,"Steerable has no target position.",e.id),this.result;var t=K.get().copy(e.targetPosition).sub(e.position),o=t.getLength(),i=K.get().set(0,0,0);return o<=this.satisfactionRadius?(j.log(U,"Arrived.",e.id),this.result):(i.copy(t).normalize().multiplyScalar(e.maxSpeed),o<=this.slowDownRadius?(j.log(U,"Slowing down.",e.id),i.multiplyScalar(o/this.slowDownRadius)):j.log(U,"Speeding up.",e.id),this.result.linear.copy(i).sub(e.velocity),this.result)},Object.defineProperty(q.prototype,"constructor",{value:q,enumerable:!1,writable:!0});var G=new x(new c(),new c()),Y=new u(10),X="AvoidBehavior",Z=function(e){O.call(this),this.maxSeeAhead=e.maxSeeAhead,this.maxAvoidForce=e.maxAvoidForce};Z.prototype=Object.create(O.prototype),Z.prototype.findMostThreateningObstacle=function(e){var t=null,o=this.maxSeeAhead,i=e.position,n=Y.get().copy(e.velocity);n.normalize().multiplyScalar(o);var r=Y.get().copy(n).add(i);return G.setFromTwoVectors(i,r,.001),G.expandByPoint(e.box.min),G.expandByPoint(e.box.max),e.executeForEachCloseEntity(function(e){if(G.intersectsBox(e.box))if(!t)t=e;else{var o=Y.get().copy(i).sub(e.position).getLength(),n=Y.get().copy(i).sub(t.position).getLength();o<=n&&(t=e)}}),t},Z.prototype.compute=function(e){this.result.linear.set(0,0,0);var t=this.findMostThreateningObstacle(e);return t?(j.log(X,"Threatening entity found.",e.id),this.result.linear.copy(e.velocity).normalize().multiplyScalar(e.velocity.getLength()/e.maxSpeed).add(e.position).sub(t.position).normalize().multiplyScalar(this.maxAvoidForce),this.result):(j.log(X,"No threatening entity found.",e.id),this.result)},Object.defineProperty(Z.prototype,"constructor",{value:Z,enumerable:!1,writable:!0});var Q=new u(10),$=function(e){O.call(this),this.definitions=e};$.prototype=Object.create(O.prototype),$.prototype.compute=function(e){this.result.linear.set(0,0,0);for(var t=0;t<this.definitions.length;t++){var o=this.definitions[t],n=o.behavior,r=o.weight,a=n.compute(e);a&&this.result.linear.add(Q.get().copy(a.linear).multiplyScalar(r))}return this.result},Object.defineProperty($.prototype,"constructor",{value:$,enumerable:!1,writable:!0});var ee=new u(10),te=function(e){W.call(this),this.maxPredictionTime=e.maxPredictionTime};te.prototype=Object.create(W.prototype),te.prototype.compute=function(e){if(this.result.linear.set(0,0,0),!e.hasTargetEntity)return j.log("PursueBehavior","Entity has no target entity.",e.id),this.result;var t=e.targetEntity,o=t.position,i=e.velocity.getLength(),n=this.maxPredictionTime;if(0<i){var r=ee.get().copy(o).sub(e.position).getLength(),a=r/i;a<this.maxPredictionTime&&(n=a)}var p=ee.get().copy(t.velocity).multiplyScalar(n).add(o);return e.setTargetPosition(p),j.log("PursueBehavior","Seeking.",e.id),W.prototype.compute.call(this,e)},Object.defineProperty(te.prototype,"constructor",{value:W,enumerable:!1,writable:!0});var oe=new u(10),ie=function(){O.call(this)};ie.prototype=Object.create(O.prototype),ie.prototype.compute=function(e){this.result.linear.set(0,0,0);var t=oe.get().copy(e.position).add(e.velocity);return e.setLookTarget(t),this.result},Object.defineProperty(ie.prototype,"constructor",{value:ie,enumerable:!1,writable:!0});var ne=new u(10),re=new b,ae=function(e){O.call(this),this.normal=e.normal.clone().normalize(),this.wanderCircleDistance=e.wanderCircleDistance,this.wanderCircleRadius=e.wanderCircleRadius,this.angleChange=e.angleChange,this.angle=0};ae.prototype=Object.create(O.prototype),ae.prototype.compute=function(e){var t=this.getCircleCenter(e),o=this.getDisplacementForce();return this.result.linear.copy(t).add(o),this.angle+=Math.random()*this.angleChange-.5*this.angleChange,this.result},ae.prototype.getCircleCenter=function(e){var t=this.wanderCircleDistance;return ne.get().copy(e.velocity).normalize().multiplyScalar(t)},ae.prototype.getDisplacementForce=function(){var e=ne.get().set(0,0,0);e.x=t(this.angle),e.z=i(this.angle),e.normalize().multiplyScalar(this.wanderCircleRadius);var o=re.setFromVectors(ne.get().set(0,1,0),this.normal);return e.applyQuaternion(o),e},Object.defineProperty(ae.prototype,"constructor",{value:ae,enumerable:!1,writable:!0});var pe=new u(10),se=function(e){ae.call(this,{wanderCircleDistance:e.wanderSphereDistance,angleChange:e.angleChange,normal:new c}),this.angle2=0,this.wanderSphereRadius=e.wanderSphereRadius};se.prototype=Object.create(ae.prototype),se.prototype.compute=function(e){var t=this.getCircleCenter(e),o=this.getDisplacementForce();return this.result.linear.copy(t).add(o),this.angle+=Math.random()*this.angleChange-.5*this.angleChange,this.angle2+=Math.random()*this.angleChange-.5*this.angleChange,this.result},se.prototype.getDisplacementForce=function(){var e=pe.get().set(0,0,0);return e.x=i(this.angle)*t(this.angle2),e.y=i(this.angle)*i(this.angle2),e.z=t(this.angle),e.normalize().multiplyScalar(this.wanderSphereRadius)},Object.defineProperty(se.prototype,"constructor",{value:se,enumerable:!1,writable:!0});var le=function(){W.call(this)};le.prototype=Object.create(W.prototype),le.prototype.compute=function(e){return W.prototype.compute.call(this,e),this.result.linear.negate(),this.result},Object.defineProperty(le.prototype,"constructor",{value:le,enumerable:!1,writable:!0});var ye=function(e){te.call(this,e)};ye.prototype=Object.create(te.prototype),ye.prototype.compute=function(e){return te.prototype.compute.call(this,e),this.result.linear.negate(),this.result},Object.defineProperty(ye.prototype,"constructor",{value:ye,enumerable:!1,writable:!0});var de=new u(10),ce="PathFollowingBehavior",ue=function(e){W.call(this),this.path=e.path,this.satisfactionRadius=e.satisfactionRadius||0,this.onJumpCompletionCallback=this.onJumpCompleted.bind(this)};ue.prototype=Object.create(W.prototype),ue.prototype.getNext=function(){var e=this.path;return e.next(),e.getCurrentWaypoint()},ue.prototype.getCurrentWaypoint=function(){return this.path.getCurrentWaypoint()},ue.prototype.compute=function(e){this.result.linear.set(0,0,0);var t=this.path,o=this.getCurrentWaypoint();if(!o)return j.log(ce,"No waypoint.",e.id),this.result;var i=this.isJumpNeeded(e);if(i)return this.beforeJumpBehavior=e.behavior,e.jumpDescriptor=i,e.onJumpReady(),e.setJumpCompletionListener(this.onJumpCompletionCallback),j.log(ce,"Jump initiated.",e.id),this.result;var n=de.get().copy(o).sub(e.position).getLength();return n<=this.satisfactionRadius&&(o=this.getNext(),j.log(ce,"Next waypoint.",e.id),!o)?(j.log(ce,"Path completed.",e.id),this.result):(e.setTargetPosition(o),W.prototype.compute.call(this,e))},ue.prototype.isJumpNeeded=function(e){for(var t=this.path,o=t.jumpDescriptors,n=0;n<t.jumpDescriptorLength;n++){var r=o[n],a=de.get().copy(e.position).sub(r.takeoffPosition).getLength();if(a<r.runupSatisfactionRadius){var p=r.solveQuadraticEquation(e);if(p)return r}}return!1},ue.prototype.onJumpCompleted=function(e){for(var t=e.jumpDescriptor,o=t.landingPosition,i=this.path,n=i.getWaypointIndex(o);i.index!=n&&!i.isFinished;)i.next();e.setBehavior(this.beforeJumpBehavior)},Object.defineProperty(ue.prototype,"constructor",{value:ue,enumerable:!1,writable:!0});var ge=function(e){O.call(this),this.threshold=e.threshold,this.list=e.list};ge.prototype=Object.create(O.prototype),ge.prototype.compute=function(e){this.result.linear.set(0,0,0);for(var t,o=0;o<this.list.length;o++)if(t=this.list[o].compute(e),t.linear.getLength()>this.threshold)return this.result.linear.copy(t.linear),j.log("PrioritySteeringBehavior","Computed.",e.id),this.result;return j.log("PrioritySteeringBehavior","Not computed.",e.id),this.result},Object.defineProperty(ge.prototype,"constructor",{value:ge,enumerable:!1,writable:!0});var me=new u(10),he="HideBehavior",xe=function(e){q.call(this,{satisfactionRadius:e.arriveSatisfactionRadius,slowDownRadius:e.arriveSlowDownRadius}),this.hideDistance=e.hideDistance,this.threatDistance=e.threatDistance,this.hidingSpotFound=!1,this.bestHidingSpot=new c};xe.prototype=Object.create(q.prototype),xe.prototype.compute=function(e){return(this.result.linear.set(0,0,0),!e.hideTargetEntity)?(j.log(he,"No hide target entity set.",e.id),this.result):me.get().copy(e.position).sub(e.hideTargetEntity.position).getLength()>this.threatDistance?(j.log(he,"Target entity is out of threat distance.",e.id),this.result):(this.findHidingSpot(e),!this.hidingSpotFound)?(j.log(he,"No hiding spot found.",e.id),this.result):(j.log(he,"Hiding.",e.id),e.setTargetPosition(this.bestHidingSpot),q.prototype.compute.call(this,e))},xe.prototype.findHidingSpot=function(e){this.hidingSpotFound=!1;var t=null,o=this;e.executeForEachCloseEntity(function(i){if(!(i instanceof H)){var n=o.getHidingPosition(i,e),r=me.get().copy(n).sub(e.position).getLength();(null==t||r<t)&&(t=r,o.hidingSpotFound=!0,o.bestHidingSpot.copy(n))}})},xe.prototype.getHidingPosition=function(e,t){var o=t.hideTargetEntity.position,i=e.box.getBoundingRadius(),n=i+this.hideDistance,r=e.position;return me.get().copy(r).sub(o).normalize().multiplyScalar(n).add(r)},Object.defineProperty(xe.prototype,"constructor",{value:xe,enumerable:!1,writable:!0});var ve=function(e){ue.call(this,e)};ve.prototype=Object.create(ue.prototype),ve.prototype.getNext=function(){var e=this.path;return this.currentWayPoint=e.getRandomWaypoint(),this.currentWayPoint},ve.prototype.getCurrentWaypoint=function(){return this.currentWayPoint?this.currentWayPoint:this.getNext()},Object.defineProperty(ve.prototype,"constructor",{value:ve,enumerable:!1,writable:!0});var fe=new u(10),ze=function(e){O.call(this),this.strength=e.strength};ze.prototype=Object.create(O.prototype),ze.prototype.compute=function(e){var t=this.result.linear;t.set(0,0,0);var o=this.strength;return e.executeForEachCloseEntity(function(i){if(i instanceof H){var n=fe.get().copy(e.position).sub(i.position),r=n.getLength();0==r||(n.normalize().multiplyScalar(o/r),t.add(n))}}),this.result},Object.defineProperty(ze.prototype,"constructor",{value:ze,enumerable:!1,writable:!0});var be=function(){O.call(this)};be.prototype=Object.create(O.prototype),be.prototype.compute=function(e){var t=this.result.linear;t.set(0,0,0);var o=0;return e.executeForEachCloseEntity(function(e){e instanceof H&&(t.add(e.velocity),o++)}),0<o?(t.multiplyScalar(1/o),t.sub(e.velocity),j.log("AlignBehavior","Close entities exist.",e.id)):j.log("AlignBehavior","No close entities exist.",e.id),this.result},Object.defineProperty(be.prototype,"constructor",{value:be,enumerable:!1,writable:!0});var Ee=function(){W.call(this)};Ee.prototype=Object.create(W.prototype),Ee.prototype.compute=function(e){var t=this.result.linear;t.set(0,0,0);var o=0;return(e.executeForEachCloseEntity(function(e){e instanceof H&&(t.add(e.position),o++)}),0<o)?(j.log("CohesionBehavior","Close entities exist.",e.id),t.multiplyScalar(1/o),e.setTargetPosition(t),W.prototype.compute.call(this,e)):(j.log("CohesionBehavior","No close entities exist.",e.id),this.result)},Object.defineProperty(Ee.prototype,"constructor",{value:Ee,enumerable:!1,writable:!0});var Se=new u(10),we="JumpBehavior",Pe=function(){O.call(this)};Pe.prototype=Object.create(O.prototype),Pe.prototype.compute=function(e){var t=this.result.linear;if(t.set(0,0,0),!e.isJumpReady)return j.log(we,"Jump not ready.",e.id),this.result;if(e.isJumpTakenOff)return j.log(we,"Jump already took off.",e.id),this.result;var o=e.jumpDescriptor,i=o.getEquationResult(e);if(0==i.time)return j.log(we,"Equation result time is zero.",e.id),this.result;var n=Se.get().set(i.vx,0,i.vz),r=Se.get().copy(e.position).sub(o.takeoffPosition).getLength();if(r<=o.takeoffPositionSatisfactionRadius){var a=Se.get().copy(e.velocity).sub(n).getLength();if(a<=o.takeoffVelocitySatisfactionRadius)return e.onJumpTakeOff(),j.log(we,"Taking off.",e.id),this.result}return j.log(we,"Matching velocity.",e.id),this.matchVelocity(i.time,n,e)},Pe.prototype.matchVelocity=function(e,t,o){var i=this.result.linear;return t.sub(o.velocity).multiplyScalar(1/e),i.copy(t),this.result},Object.defineProperty(Pe.prototype,"constructor",{value:Pe,enumerable:!1,writable:!0});var De=function(e){var t=e.graph,o=new M(t),i=[];t.forEachVertex(function(e,t,o){i.push(new c(e,t,o))}),ue.call(this,{path:o.path,satisfactionRadius:e.satisfactionRadius}),this.aStar=o,this.allVertices=i,this.isPathConstructed=!1,o.path.finishCallback=function(){this.isPathConstructed=!1}.bind(this)};De.prototype=Object.create(ue.prototype),De.prototype.getRandomWaypoint=function(){var e=this.allVertices;return e[o(Math.random()*e.length)]||null},De.prototype.constructPath=function(e){for(var t=!0,o=this.aStar,i=o.graph;t;){var n=i.findClosestVertexToPoint(e.position);n||(n=this.getRandomWaypoint());var r=this.getRandomWaypoint(),a=o.findShortestPath(n,r);t=!a}this.isPathConstructed=!0},De.prototype.compute=function(e){return this.isPathConstructed||(j.log("RandomPathBehavior","Path constructed.",e.id),this.constructPath(e)),j.log("RandomPathBehavior","Following path.",e.id),ue.prototype.compute.call(this,e)},Object.defineProperty(De.prototype,"constructor",{value:De,enumerable:!1,writable:!0});var Be=new x(new c(),new c()),Ce=new c,Ie=function(e,t,o){this.world=e,this.threeInstance=t,this.scene=o,this.isActive=!1,this.limeMaterial=new t.MeshBasicMaterial({color:"lime",wireframe:!0}),this.magentaMaterial=new t.MeshBasicMaterial({color:"magenta",wireframe:!0}),this.redMaterial=new t.MeshBasicMaterial({color:"red",wireframe:!1}),this.orangeMaterial=new t.MeshBasicMaterial({color:"orange",wireframe:!1}),this.lineMaterial=new t.LineBasicMaterial({color:"cyan"}),this.worldMesh=null,this.meshesByEntityID={},this.velocityMeshesByEntityID={},this.lookMeshesByEntityID={},this.pathMeshes=[],this.edgeMeshes=[],this.LOOK_DISTANCE=100,this.world.onEntityInserted=function(e){this.isActive&&this.addEntity(e)}.bind(this),this.world.onEntityRemoved=function(e){if(this.isActive){var t=this.meshesByEntityID[e.id];if(this.scene.remove(t),delete this.meshesByEntityID[e.id],e instanceof H){var o=this.velocityMeshesByEntityID[e.id];this.scene.remove(o),delete this.velocityMeshesByEntityID[e.id];var i=this.lookMeshesByEntityID[e.id];this.scene.remove(i),delete this.lookMeshesByEntityID[e.id]}}}.bind(this),this.world.onEntityUpdated=function(e){if(this.isActive){var t=this.meshesByEntityID[e.id];t.position.set(e.position.x,e.position.y,e.position.z);var o=t.geometry.parameters;if(t.scale.set(e.size.x/o.width,e.size.y/o.height,e.size.z/o.depth),e instanceof H){var i=this.velocityMeshesByEntityID[e.id];Ce.copy(e.position).add(e.velocity),Be.setFromTwoVectors(e.position,Ce,5),Ce.x=(Ce.x+e.position.x)/2,Ce.y=(Ce.y+e.position.y)/2,Ce.z=(Ce.z+e.position.z)/2,i.position.set(Ce.x,Ce.y,Ce.z),i.scale.set(Be.max.x-Be.min.x,Be.max.y-Be.min.y,Be.max.z-Be.min.z);var n=this.lookMeshesByEntityID[e.id];Ce.copy(e.lookDirection).normalize().multiplyScalar(this.LOOK_DISTANCE).add(e.position),n.position.set(Ce.x,Ce.y,Ce.z)}}}.bind(this),this.world.onEntityLookDirectionUpdated=function(e){if(this.isActive&&e instanceof H){var t=this.lookMeshesByEntityID[e.id];Ce.copy(e.lookDirection).normalize().multiplyScalar(this.LOOK_DISTANCE).add(e.position),t.position.set(Ce.x,Ce.y,Ce.z)}}.bind(this)};Ie.prototype.visualisePath=function(e){for(var t=0;t<e.waypoints.length;t++){var o=e.waypoints[t],n=new this.threeInstance.Mesh(new this.threeInstance.BoxBufferGeometry(5,5,5),this.orangeMaterial);n.position.set(o.x,o.y,o.z),this.scene.add(n),this.pathMeshes.push(n)}},Ie.prototype.visualiseGraph=function(e){var t=this.threeInstance,o=this.lineMaterial,i=this.scene,n=this.edgeMeshes;e.forEachEdge(function(e){var r=new t.Geometry;r.vertices.push(e.fromVertex),r.vertices.push(e.toVertex);var a=new t.Line(r,o);i.add(a),n.push(a)})},Ie.prototype.addEntity=function(e){var t=this.createMeshFromEntity(e);if(this.meshesByEntityID[e.id]=t,this.scene.add(t),e instanceof H){var o=new this.threeInstance.Mesh(new this.threeInstance.BoxBufferGeometry(1,1,1),this.magentaMaterial);o.position.set(e.position.x,e.position.y,e.position.z),this.scene.add(o),this.velocityMeshesByEntityID[e.id]=o;var i=new this.threeInstance.Mesh(new this.threeInstance.BoxBufferGeometry(5,5,5),this.redMaterial),n=new c().copy(e.lookDirection).normalize().add(e.position).multiplyScalar(this.LOOK_DISTANCE);i.position.set(n.x,n.y,n.z),this.scene.add(i),this.lookMeshesByEntityID[e.id]=i}},Ie.prototype.activate=function(){this.isActive=!0;var e=new this.threeInstance.BoxBufferGeometry(this.world.width,this.world.height,this.world.depth);this.worldMesh=new this.threeInstance.Mesh(e,this.limeMaterial),this.scene.add(this.worldMesh),this.world.forEachEntity(function(e){this.addEntity(e)}.bind(this))},Ie.prototype.deactivate=function(){for(var e in this.isActive=!1,this.scene.remove(this.worldMesh),this.worldMesh=null,this.meshesByEntityID)this.scene.remove(this.meshesByEntityID[e]);for(var e in this.velocityMeshesByEntityID)this.scene.remove(this.velocityMeshesByEntityID[e]);for(var e in this.lookMeshesByEntityID)this.scene.remove(this.lookMeshesByEntityID[e]);for(var t=0;t<this.pathMeshes.length;t++)this.scene.remove(this.pathMeshes[t]);for(var t=0;t<this.edgeMeshes.length;t++)this.scene.remove(this.edgeMeshes[t]);this.meshesByEntityID={},this.velocityMeshesByEntityID={},this.lookMeshesByEntityID={},this.pathMeshes=[],this.edgeMeshes=[]},Ie.prototype.createMeshFromEntity=function(e){var t=new this.threeInstance.BoxBufferGeometry(e.size.x,e.size.y,e.size.z),o=new this.threeInstance.Mesh(t,this.limeMaterial);return o.position.set(e.position.x,e.position.y,e.position.z),o},e.MathUtils=m,e.Vector3D=c,e.VectorPool=u,e.Box=x,e.World=C,e.Entity=P,e.Quaternion=b,e.Path=I,e.Edge=T,e.Graph=k,e.MinHeap=R,e.AStar=M,e.Vertex=B,e.Steerable=H,e.SteerResult=N,e.JumpDescriptor=_,e.SteeringBehavior=O,e.SeekBehavior=W,e.ArriveBehavior=q,e.AvoidBehavior=Z,e.BlendedSteeringBehavior=$,e.PursueBehavior=te,e.LookWhereYouAreGoingBehavior=ie,e.Wander2DBehavior=ae,e.Wander3DBehavior=se,e.FleeBehavior=le,e.EvadeBehavior=ye,e.PathFollowingBehavior=ue,e.PrioritySteeringBehavior=ge,e.HideBehavior=xe,e.RandomWaypointBehavior=ve,e.SeparationBehavior=ze,e.AlignBehavior=be,e.CohesionBehavior=Ee,e.JumpBehavior=Pe,e.RandomPathBehavior=De,e.DebugHelper=Ie,e.logger=j,Object.defineProperty(e,"__esModule",{value:!0})});